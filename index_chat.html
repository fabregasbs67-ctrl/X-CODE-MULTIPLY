<!DOCTYPE html>
<html lang="es">
<head>
  <meta charset="utf-8">
  <meta name="viewport" content="width=device-width, initial-scale=1, maximum-scale=1, viewport-fit=cover">
  <title>X Code Chat ‚Äî Official</title>
  <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;600&display=swap" rel="stylesheet">
  <style>
    :root{ --bg:#000; --fg:#fff; --line:#2a2a2a; --muted:#bdbdbd; }
    *{ box-sizing:border-box; -webkit-tap-highlight-color: transparent; }
    html,body{ height:100%; }
    body{
      margin:0; background:#000; color:#fff;
      font-family: Inter, system-ui, -apple-system, Segoe UI, Roboto, Arial, sans-serif;
    }
    .wrap{ max-width:900px; margin:0 auto; padding:16px; display:flex; flex-direction:column; gap:12px; min-height:100vh; }
    .card{ border:1px solid var(--line); border-radius:16px; background:rgba(255,255,255,0.02); padding:14px; }
    .header{ display:flex; align-items:center; gap:12px; }
    .logo{
      width:22px; height:22px; border-radius:50%;
      background:#000 url('https://raw.githubusercontent.com/fabregasbs67-ctrl/X-CODE-MULTIPLY/main/assets/x_logo.png') center/cover no-repeat;
      border:1px solid #555;
      transform: translateY(1px);
    }
    h1{ margin:0; font-size:22px; line-height:1.1; font-weight:700; }
    .sub{ margin:4px 0 0 0; font-size:13px; color:var(--muted); }
    /* Login centrado */
    .loginBox{ display:grid; grid-template-columns:1fr; gap:10px; max-width:560px; margin:8px auto; }
    .centerLogin{ flex:1; display:flex; align-items:center; justify-content:center; }
    input, button, select{
      border-radius:12px; padding:14px; font-size:16px; outline:none;
    }
    input, select{
      width:100%; background:transparent; color:var(--fg); border:1px solid #fff;
    }
    input::placeholder{ color:#8d8d8d; }
    button{ border:1px solid #fff; background:#fff; color:#000; font-weight:600; cursor:pointer; }
    button.ghost{ background:transparent; color:#fff; }
    .row{ display:flex; gap:10px; flex-wrap:wrap; }
    /* Chat */
    .chat{ display:none; flex-direction:column; gap:10px; border:1px solid var(--line); border-radius:16px; padding:10px; background:rgba(255,255,255,0.02); height:68vh; min-height:420px; }
    .scroll{ flex:1 1 auto; overflow:auto; padding:6px; }
    .welcome{ position:sticky; top:0; background:rgba(0,0,0,.6); border:1px dashed #555; border-radius:10px; padding:8px 10px; margin-bottom:6px; }
    .msg{ display:inline-block; max-width:min(84%,680px); background:#0a0a0a; border:1px solid #707070; border-radius:14px; padding:10px 12px; margin:4px 0; word-break:break-word; }
    .me{ margin-left:auto; border-color:#9d9d9d; }
    .meta{ color:#9a9a9a; font-size:12px; margin-top:4px; }
    .system{ border-style:dashed; color:#e6e6e6; }
    .composer{ display:flex; gap:10px; align-items:center; position:sticky; bottom:0; background:rgba(0,0,0,.9); padding-top:6px; }
    .composer input{ flex:1 1 auto; }
    .hint{ text-align:center; font-size:12px; color:#9a9a9a; }
    /* Admin */
    .admin{ display:none; border:1px solid var(--line); border-radius:12px; padding:10px; background:rgba(255,255,255,.02); }
    .users .rowu{ display:grid; grid-template-columns:60px 1fr 120px 120px; gap:8px; padding:6px 0; border-bottom:1px dashed #2b2b2b; align-items:center; }
    .users .rowu:last-child{ border-bottom:none; }
    .status{ font-size:12px; color:#bdbdbd; }
    .topbar{ display:flex; align-items:center; gap:10px; justify-content:space-between; }
    .right{ display:flex; align-items:center; gap:8px; }
    .rooms{ display:none; gap:8px; flex-wrap:wrap; align-items:center; margin-top:8px; }
    @media (max-width:560px){
      h1{ font-size:20px; }
      .chat{ height:64vh; }
      .users .rowu{ grid-template-columns:50px 1fr 96px 100px; }
    }
  </style>
</head>
<body>
  <div class="wrap">
    <div class="card">
      <div class="topbar">
        <div class="header">
          <div class="logo" aria-label="X Code logo"></div>
          <div>
            <h1>X Code Chat ‚Äî Official</h1>
            <p class="sub">Sala: <b id="roomName">Sala de Prueba</b></p>
          </div>
        </div>
        <div class="right">
          <button id="btnLogout" class="ghost" style="display:none">Salir</button>
        </div>
      </div>
      <!-- LOGIN -->
      <div class="centerLogin" id="loginWrap">
        <div id="login" class="loginBox">
          <p class="sub" id="loginHelp">Acceso con <b>n√∫mero</b> y <b>PIN</b>. Si es tu primer acceso, el PIN se genera autom√°ticamente.</p>
          <input id="inpNum" type="number" inputmode="numeric" min="0" placeholder="Tu n√∫mero (ej. 70)">
          <input id="inpPin" type="password" placeholder="Tu PIN (si ya tienes)">
          <div class="row">
            <button id="btnEnter">Entrar</button>
          </div>
          <p id="loginMsg" class="sub" style="margin:0"></p>
        </div>
      </div>
    </div>

    <!-- ADMIN (solo usuario 0) -->
    <div id="admin" class="admin">
      <div class="row" style="justify-content:space-between; align-items:center;">
        <div class="sub">Panel del organizador (usuario 0)</div>
        <div class="row">
          <button id="btnGlobal" class="ghost">Mensaje global</button>
          <button id="btnAuto" class="ghost">Mensajes auto: OFF</button>
        </div>
      </div>

      <!-- Rooms (solo admin) -->
      <div id="rooms" class="rooms">
        <select id="selRoom"></select>
        <input id="roomNew" type="text" placeholder="Nuevo nombre de sala‚Ä¶">
        <button id="roomUse">Usar</button>
        <button id="roomAdd" class="ghost">A√±adir</button>
        <button id="roomRen" class="ghost">Renombrar</button>
        <button id="roomDel" class="ghost">Eliminar</button>
      </div>

      <div id="users" class="users"></div>
    </div>

    <!-- CHAT -->
    <div id="chat" class="chat">
      <div id="scroll" class="scroll">
        <div id="welcome" class="welcome">üëã Bienvenido. A√∫n no hay mensajes. Este aviso desaparecer√° en cuanto se publique alguno.</div>
        <div id="msgs"></div>
      </div>
      <div class="composer">
        <input id="inpText" type="text" placeholder="Escribe un mensaje‚Ä¶ ¬∑ Privado: @120 hola">
        <button id="btnSend">Enviar</button>
      </div>
      <div class="hint">P√∫blico por defecto ¬∑ Privado con <b>@n√∫mero</b> (ej. @120 hola)</div>
    </div>
  </div>

<script type="module">
  // ===== CONFIG =====
  const DEFAULT_ROOM = "Sala de Prueba";
  const ADMIN_PASSWORD = "131215";
  const AUTO_EVERY_MIN = 10;

  // Firebase (misma config)
  import { initializeApp } from "https://www.gstatic.com/firebasejs/10.12.2/firebase-app.js";
  import {
    getDatabase, ref, get, set, update, onValue, onDisconnect, remove
  } from "https://www.gstatic.com/firebasejs/10.12.2/firebase-database.js";

  const firebaseConfig = {
    apiKey: "AIzaSyD66wsrvZmQmzmp0htKmrxCbFwOmeijqiQ",
    authDomain: "x-code-chat.firebaseapp.com",
    databaseURL: "https://x-code-chat-default-rtdb.europe-west1.firebasedatabase.app",
    projectId: "x-code-chat",
    storageBucket: "x-code-chat.firebasestorage.app",
    messagingSenderId: "819845037951",
    appId: "1:819845037951:web:f0fe8971356afb2f66a44a"
  };
  const app = initializeApp(firebaseConfig);
  const db  = getDatabase(app);

  // ===== UI refs =====
  const loginWrap= document.getElementById('loginWrap');
  const login    = document.getElementById('login');
  const chat     = document.getElementById('chat');
  const admin    = document.getElementById('admin');
  const usersBox = document.getElementById('users');
  const btnLogout= document.getElementById('btnLogout');

  const inpNum   = document.getElementById('inpNum');
  const inpPin   = document.getElementById('inpPin');
  const btnEnter = document.getElementById('btnEnter');
  const loginHelp= document.getElementById('loginHelp');
  const loginMsg = document.getElementById('loginMsg');

  const roomName = document.getElementById('roomName');
  const scrollEl = document.getElementById('scroll');
  const msgsEl   = document.getElementById('msgs');
  const welcome  = document.getElementById('welcome');
  const inpText  = document.getElementById('inpText');
  const btnSend  = document.getElementById('btnSend');
  const btnGlobal= document.getElementById('btnGlobal');
  const btnAuto  = document.getElementById('btnAuto');

  // Rooms (admin only)
  const roomsBar = document.getElementById('rooms');
  const selRoom  = document.getElementById('selRoom');
  const roomNew  = document.getElementById('roomNew');
  const roomUse  = document.getElementById('roomUse');
  const roomAdd  = document.getElementById('roomAdd');
  const roomRen  = document.getElementById('roomRen');
  const roomDel  = document.getElementById('roomDel');

  // ===== Estado =====
  let state = {
    room: localStorage.getItem('xc_room') || DEFAULT_ROOM,
    me:   localStorage.getItem('xc_me')   || null,
    role: localStorage.getItem('xc_role') || null,  // 'admin' | 'user'
    pin:  localStorage.getItem('xc_pin')  || null,
    sess: localStorage.getItem('xc_sess') || null,
    subs: { msgsOff:null, usersOff:null },
    autoTimer:null
  };
  roomName.textContent = state.room;

  function save(){ localStorage.setItem('xc_room', state.room);
                   localStorage.setItem('xc_me',   state.me||'');
                   localStorage.setItem('xc_role', state.role||'');
                   localStorage.setItem('xc_pin',  state.pin||'');
                   localStorage.setItem('xc_sess', state.sess||''); }

  function show(el,on){ el.style.display = on ? (el.classList.contains('chat')?'flex':'block') : 'none'; }
  function stick(){ setTimeout(()=>{ scrollEl.scrollTop = scrollEl.scrollHeight; }, 30); }
  const uid = () => Math.random().toString(36).slice(2);

  // ===== Rooms helpers =====
  async function refreshRooms(){
    const snap = await get(ref(db,'roomsMeta'));
    selRoom.innerHTML='';
    const opt = document.createElement('option');
    opt.value = state.room; opt.textContent = state.room;
    selRoom.appendChild(opt);
    if(snap.exists()){
      const meta = snap.val();
      Object.keys(meta).forEach(id=>{
        if(id===state.room) return;
        const o=document.createElement('option');
        o.value=id; o.textContent=meta[id].name||id;
        selRoom.appendChild(o);
      });
    }
    selRoom.value = state.room;
  }
  async function ensureRoomMeta(r){
    await update(ref(db,`roomsMeta/${r}`),{ name:r, updatedAt: Date.now() });
  }

  // ===== Auto re-login (persistente) =====
  (async function boot(){
    await ensureRoomMeta(state.room);
    if(state.me && state.role){
      show(loginWrap,false);
      show(chat,true);
      btnLogout.style.display='inline-block';
      if(state.role==='admin'){ show(admin,true); roomsBar.style.display='flex'; refreshRooms(); }
      else { show(admin,false); roomsBar.style.display='none'; }
      attach();
    } else {
      centerLogin();
    }
  })();

  function centerLogin(){
    show(loginWrap,true); show(chat,false); show(admin,false);
    roomsBar.style.display='none';
    btnLogout.style.display='none';
    setTimeout(()=>{ login.scrollIntoView({block:'center'}); }, 10);
  }

  // ===== Login =====
  inpNum.addEventListener('input', ()=>{
    if(String(inpNum.value).trim()==='0'){
      inpPin.placeholder = 'Contrase√±a admin';
      loginHelp.textContent = 'Acceso admin: usa el n√∫mero 0 y la contrase√±a.';
    }else{
      inpPin.placeholder = 'Tu PIN (si ya tienes)';
      loginHelp.innerHTML = 'Acceso con <b>n√∫mero</b> y <b>PIN</b>. Si es tu primer acceso, el PIN se genera autom√°ticamente.';
    }
  });

  btnEnter.addEventListener('click', async ()=>{
    loginMsg.textContent='';
    const code = String((inpNum.value||'').trim());
    const pin  = String((inpPin.value||'').trim());

    if(!code){ loginMsg.textContent='Introduce tu n√∫mero.'; return; }

    if(code === '0'){ // admin sin PIN
      if(pin !== ADMIN_PASSWORD){ loginMsg.textContent='Contrase√±a admin incorrecta.'; return; }
      state.me='0'; state.role='admin'; state.pin=''; save();
      show(loginWrap,false); show(chat,true); show(admin,true); roomsBar.style.display='flex'; btnLogout.style.display='inline-block';
      await refreshRooms();
      attach(); return;
    }

    const uref = ref(db, `rooms/${state.room}/users/${code}`);
    const snap = await get(uref);
    if(!snap.exists()){
      const newPin = String(Math.floor(1000+Math.random()*9000));
      await set(uref, { pin:newPin, active:true, createdAt: Date.now(), welcomeShown:false });
      loginMsg.innerHTML = `Tu PIN es <b>${newPin}</b>. Se ha guardado en este dispositivo.<br>Vuelve a pulsar <b>Entrar</b> para acceder.`;
      localStorage.setItem('xc_pin', newPin);
      return;
    }else{
      const data = snap.val();
      if(data.active===false){ loginMsg.textContent='Tu acceso est√° desactivado por el organizador.'; return; }
      if(!pin){ loginMsg.textContent='PIN faltante. P√≠dele tu PIN al organizador.'; return; }
      if(String(data.pin)!==pin){ loginMsg.textContent='PIN incorrecto.'; return; }
      // session lock
      const sessRef = ref(db, `rooms/${state.room}/activeSessions/${code}`);
      const curr = await get(sessRef);
      if(curr.exists()){
        const existing = curr.val();
        if(existing.sessionId && existing.sessionId !== state.sess){
          loginMsg.textContent='Tu n√∫mero ya est√° conectado en otro dispositivo.';
          return;
        }
      }
      const newSess = `${code}-${Date.now()}-${uid()}`;
      await set(sessRef, { sessionId:newSess, since: Date.now() });
      try{ onDisconnect(sessRef).remove(); }catch(e){}
      state.sess = newSess;

      state.me = code; state.role='user'; state.pin = pin; save();
      show(loginWrap,false); show(chat,true); show(admin,false); roomsBar.style.display='none'; btnLogout.style.display='inline-block';
      attach();
    }
  });

  // ===== Rooms admin =====
  roomUse.onclick = async ()=>{
    const sel = selRoom.value;
    if(sel===state.room) return;
    // clear session and switch
    await disconnectSessionIfAny();
    state.room = sel; save();
    roomName.textContent = state.room;
    await ensureRoomMeta(state.room);
    attach();
  };
  roomAdd.onclick = async ()=>{
    const name = (roomNew.value||'').trim(); if(!name) return;
    await ensureRoomMeta(name); roomNew.value=''; refreshRooms();
  };
  roomRen.onclick = async ()=>{
    const name = (roomNew.value||'').trim(); if(!name) return;
    await update(ref(db,`roomsMeta/${state.room}`),{ name }); refreshRooms();
  };
  roomDel.onclick = async ()=>{
    const id = selRoom.value; if(!confirm(`Eliminar sala "${id}"?`)) return;
    await remove(ref(db,`roomsMeta/${id}`)); refreshRooms();
  };

  // ===== Suscripciones =====
  function detach(){
    if(state.subs.msgsOff) state.subs.msgsOff();
    if(state.subs.usersOff) state.subs.usersOff();
    state.subs.msgsOff = state.subs.usersOff = null;
  }

  function attach(){
    detach();
    // bienvenida persistente hasta primer mensaje visible
    let hasAny = false;

    // mensajes
    const mref = ref(db, `rooms/${state.room}/messages`);
    state.subs.msgsOff = onValue(mref, (snap)=>{
      const wasAtBottom = (scrollEl.scrollTop + scrollEl.clientHeight + 10) >= scrollEl.scrollHeight;
      msgsEl.innerHTML = '';
      const arr = [];
      if(snap.exists()){
        const v = snap.val();
        for(const k of Object.keys(v)) arr.push(v[k]);
        arr.sort((a,b)=>(a.ts||0)-(b.ts||0));
      }
      for(const m of arr){
        // privados: solo ver si es tuyo o dirigido a ti, o sistema
        if(m.to && String(m.to)!==String(state.me) && String(m.from)!==String(state.me) && m.from!=='ORG') continue;
        const el = document.createElement('div');
        const isMe = String(m.from)===String(state.me);
        el.className = 'msg'+(isMe?' me':'')+(m.system?' system':'');
        el.innerHTML = (m.text||'').replace(/</g,'&lt;').replace(/\n/g,'<br>');
        const meta = document.createElement('div');
        meta.className = 'meta';
        const t = new Date(m.ts||Date.now());
        meta.textContent = (m.system?'¬∑ Sistema ¬∑ ':`#${m.from}`)+(m.to?` ‚Üí @${m.to}`:'')+` ¬∑ ${String(t.getHours()).padStart(2,'0')}:${String(t.getMinutes()).padStart(2,'0')}`;
        el.appendChild(meta);
        msgsEl.appendChild(el);
        hasAny = true;
      }
      if(hasAny) welcome.style.display='none';
      // auto scroll siempre al final (seg√∫n tu petici√≥n)
      stick();
    });

    // usuarios (solo admin ve PIN y controles)
    if(state.role==='admin'){
      roomsBar.style.display='flex';
      refreshRooms();
      const uref = ref(db, `rooms/${state.room}/users`);
      state.subs.usersOff = onValue(uref, (snap)=>{
        usersBox.innerHTML = '<div class="sub" style="margin-bottom:6px">Usuarios (PIN visible solo para admin)</div>';
        if(!snap.exists()){ usersBox.innerHTML += '<div class="status">Sin usuarios a√∫n.</div>'; return; }
        const v = snap.val();
        const ids = Object.keys(v).sort((a,b)=>Number(a)-Number(b));
        for(const id of ids){
          const u = v[id];
          const row = document.createElement('div');
          row.className = 'rowu';
          row.innerHTML = `
            <div>#${id}</div>
            <div class="status">PIN: <b>${u.pin||'‚Äî'}</b> ¬∑ ${u.active===false?'<span style="color:#ffbebe">Desactivado</span>':'Activo'}</div>
            <button class="ghost" data-act="${u.active===false?'activar':'desactivar'}" data-id="${id}" style="border-color:${u.active===false?'#ff6b6b':'#77ff77'};color:${u.active===false?'#ff6b6b':'#77ff77'}">${u.active===false?'Activar':'Desactivar'}</button>
            <button class="" data-kick="${id}">Desconectar</button>
          `;
          usersBox.appendChild(row);
        }
        // eventos
        usersBox.querySelectorAll('button[data-act]').forEach(btn=>{
          btn.onclick = async ()=>{
            const id = btn.getAttribute('data-id');
            const act = btn.getAttribute('data-act');
            await update(ref(db, `rooms/${state.room}/users/${id}`), { active: (act==='activar') });
          };
        });
        usersBox.querySelectorAll('button[data-kick]').forEach(btn=>{
          btn.onclick = async ()=>{
            const id = btn.getAttribute('data-kick');
            // corta sesi√≥n
            await remove(ref(db, `rooms/${state.room}/activeSessions/${id}`));
            alert(`Sesi√≥n del usuario ${id} desconectada.`);
          };
        });
      });
    }else{
      roomsBar.style.display='none';
    }
  }

  async function disconnectSessionIfAny(){
    if(state.me && state.me!=='0' && state.sess){
      try{ await remove(ref(db, `rooms/${state.room}/activeSessions/${state.me}`)); }catch(e){}
      state.sess=null; save();
    }
  }

  // ===== Enviar mensajes =====
  function parsePrivate(txt){
    const m = txt.match(/^@(\d+)\s+(.*)$/);
    if(!m) return null;
    return { to: parseInt(m[1],10), text: m[2] };
  }

  btnSend.addEventListener('click', async ()=>{
    const raw = (inpText.value||'').trim();
    if(!raw) return;
    // bloquea si desactivado
    if(state.role!=='admin'){
      const u = await get(ref(db, `rooms/${state.room}/users/${state.me}`));
      if(u.exists() && u.val().active===false){ alert('No puedes enviar mensajes: est√°s desactivado.'); return; }
    }
    const p = parsePrivate(raw);
    const payload = p
      ? { id: Date.now()+uid(), from: state.me, to: p.to, text: p.text, ts: Date.now(), system:false }
      : { id: Date.now()+uid(), from: state.me, to: null,  text: raw,     ts: Date.now(), system:false };
    await set(ref(db, `rooms/${state.room}/messages/${payload.id}`), payload);
    inpText.value=''; stick();
  });

  // ===== Mensaje global y auto (admin) =====
  btnGlobal.addEventListener('click', async ()=>{
    if(state.role!=='admin') return;
    const txt = prompt('Mensaje global (aparecer√° para todos):');
    if(!txt) return;
    const m = { id: Date.now()+uid(), from:'ORG', to:null, text:txt, ts:Date.now(), system:true };
    await set(ref(db, `rooms/${state.room}/messages/${m.id}`), m);
  });

  btnAuto.addEventListener('click', ()=>{
    if(state.role!=='admin') return;
    const isOn = !!state.autoTimer;
    if(isOn){
      clearInterval(state.autoTimer); state.autoTimer=null;
      btnAuto.textContent='Mensajes auto: OFF';
      alert('Mensajes autom√°ticos DESACTIVADOS');
    }else{
      const ms = AUTO_EVERY_MIN*60*1000;
      state.autoTimer = setInterval(async ()=>{
        const tips=[
          'Consejo: usa @n√∫mero para enviar privado.',
          'Respeta las normas del evento.',
          'Si necesitas ayuda, escribe @0 para contactar al organizador.',
          'Tip: desliza hacia arriba para ver mensajes anteriores.'
        ];
        const txt=tips[Math.floor(Math.random()*tips.length)];
        const m = { id: Date.now()+uid(), from:'ORG', to:null, text:txt, ts:Date.now(), system:true };
        await set(ref(db, `rooms/${state.room}/messages/${m.id}`), m);
      }, ms);
      btnAuto.textContent='Mensajes auto: ON';
      alert(`Mensajes autom√°ticos ACTIVADOS cada ${AUTO_EVERY_MIN} min`);
    }
  });

  // ===== Logout =====
  btnLogout.addEventListener('click', async ()=>{
    await disconnectSessionIfAny();
    localStorage.removeItem('xc_me');
    localStorage.removeItem('xc_role');
    localStorage.removeItem('xc_pin');
    show(chat,false); show(admin,false); centerLogin();
  });
</script>
</body>
</html>

