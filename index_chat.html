<!DOCTYPE html>
<html lang="es">
<head>
<meta charset="utf-8"/>
<meta name="viewport" content="width=device-width, initial-scale=1"/>
<title>X Code Chat ‚Äî Official</title>
<link rel="preconnect" href="https://fonts.googleapis.com">
<link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600&display=swap" rel="stylesheet">
<style>
  :root{
    --bg:#000;           /* fondo negro global */
    --fg:#fff;           /* texto blanco */
    --muted:#bdbdbd;     /* textos secundarios */
    --line:#333;         /* l√≠neas finas */
    --accent:#ffffff;    /* bordes/botones blancos (modo minimal) */
    --bubble:#0a0a0a;    /* burbuja fondo */
    --bubbleLine:#707070;/* borde burbuja */
    --ok:#b7f397;        /* indicadores sutiles */
    --warn:#ffd39a;
  }
  *{box-sizing:border-box}
  html,body{height:100%}
  body{
    margin:0;background:var(--bg);color:var(--fg);
    font-family:Inter,system-ui,-apple-system,Segoe UI,Roboto,Arial,sans-serif;
    display:flex;align-items:stretch;justify-content:center;
  }

  /* Contenedor principal centrado y fluido */
  .wrap{
    width:100%;max-width:880px;padding:18px;
    display:flex;flex-direction:column;gap:14px;
  }

  /* CABECERA / LOGIN CARD */
  .card{
    border:1px solid var(--line);
    border-radius:16px;padding:16px;
    background:rgba(255,255,255,0.02);
  }
  .header{
    display:flex;align-items:center;gap:12px;margin-bottom:4px;
  }
  .logo{
    width:32px;height:32px;border-radius:50%;
    background:#000 url("https://raw.githubusercontent.com/fabregasbs67-ctrl/X-CODE-MULTIPLY/main/assets/x_logo.png") center/cover no-repeat;
    border:1px solid #555;
  }
  h1{font-size:22px;line-height:1.15;margin:0 0 2px 0;font-weight:700}
  .sub{color:var(--muted);font-size:14px;margin:0 0 10px 0}

  /* Login centrado y minimal */
  .login{
    display:grid;grid-template-columns:1fr;gap:10px;max-width:560px;margin:0 auto;
  }
  .row{display:flex;gap:10px;flex-wrap:wrap}
  input[type="number"],input[type="text"],input[type="password"],select{
    width:100%;padding:14px 14px;border-radius:12px;
    background:transparent;border:1px solid var(--accent);color:var(--fg);
    font-size:16px;outline:none;
  }
  input::placeholder{color:#8d8d8d}
  button{
    padding:12px 18px;border-radius:12px;border:1px solid var(--accent);
    background:#fff;color:#000;font-weight:600;cursor:pointer;
  }
  button.ghost{background:transparent;color:#fff}
  button.small{padding:8px 12px;font-size:14px}

  /* Panel admin (solo usuario 0) */
  .adminBar{display:none;gap:8px;flex-wrap:wrap;align-items:center;margin-top:8px}
  .adminBar .pill{border:1px solid var(--accent);border-radius:999px;padding:8px 10px}
  .roomLine{display:none;gap:8px;flex-wrap:wrap;align-items:center;margin-top:8px}

  /* Chat area */
  .chat{
    display:none;flex-direction:column;gap:10px;height:65vh;min-height:420px;
    border:1px solid var(--line);border-radius:16px;padding:10px;background:rgba(255,255,255,0.02);
  }
  .scroll{flex:1 1 auto;overflow:auto;padding:6px}
  .bubble{
    display:inline-block;max-width:min(84%,680px);
    background:var(--bubble);border:1px solid var(--bubbleLine);border-radius:14px;
    padding:10px 12px;margin:4px 0;color:var(--fg);word-break:break-word;
  }
  .me{margin-left:auto;border-color:#999}
  .meta{color:#9a9a9a;font-size:12px;margin-top:4px}
  .system{border-style:dashed;color:#e6e6e6}
  .composer{display:flex;gap:10px;align-items:center;margin-top:4px}
  .composer input{flex:1 1 auto}
  .hint{font-size:12px;color:#9a9a9a;margin-top:4px;text-align:center}

  /* Lista de usuarios para admin */
  .users{
    display:none;border:1px solid var(--line);border-radius:12px;padding:10px;margin-top:8px;
    max-height:240px;overflow:auto;background:rgba(255,255,255,0.02);
  }
  .userRow{display:grid;grid-template-columns:60px 1fr 100px 120px;gap:8px;align-items:center;padding:6px 0;border-bottom:1px dashed #2b2b2b}
  .userRow:last-child{border-bottom:none}
  .status{font-size:12px;color:#bdbdbd}

  /* Bienvenida pegajosa hasta primer mensaje */
  .welcome{position:sticky;top:0;background:rgba(0,0,0,0.6);backdrop-filter:blur(2px);
    border:1px dashed #5b5b5b;border-radius:10px;padding:8px 10px;margin:0 0 6px 0}

  @media (max-width:520px){
    h1{font-size:20px}
    .chat{height:64vh}
    .userRow{grid-template-columns:50px 1fr 88px 100px}
  }
</style>
</head>
<body>
<div class="wrap">

  <!-- CABECERA -->
  <div class="card">
    <div class="header">
      <div class="logo" aria-label="X Code logo"></div>
      <div>
        <h1>X Code Chat ‚Äî Official</h1>
        <p class="sub">Sala: <span id="roomName">X Code</span></p>
      </div>
    </div>

    <!-- LOGIN -->
    <div id="loginBox" class="login">
      <p class="sub" id="loginHelp">
        Acceso con <b>n√∫mero</b> y <b>PIN</b>. Si es tu primer acceso, el PIN se genera autom√°ticamente.
      </p>
      <input id="inpNumber" type="number" inputmode="numeric" min="0" placeholder="Tu n√∫mero (ej. 70)"/>
      <input id="inpPin" type="password" placeholder="Tu PIN (si ya tienes)"/>
      <div class="row">
        <button id="btnEnter">Entrar</button>
        <!-- (Se elimin√≥ ‚ÄúMostrar mi PIN‚Äù para usuarios normales) -->
      </div>

      <!-- Panel organizador SOLO usuario 0 -->
      <div id="adminBar" class="adminBar">
        <span class="pill">Conectado como admin</span>
        <button id="btnAdminOn" class="small">Entrar admin</button>
        <button id="btnAdminOff" class="small ghost">Salir admin</button>
        <button id="btnAuto" class="small">Mensajes auto: OFF</button>
        <button id="btnGlobalMsg" class="small ghost">Enviar mensaje global</button>
      </div>

      <!-- Selector de sala (solo admin) -->
      <div id="roomLine" class="roomLine">
        <select id="selRoom"></select>
        <input id="roomNewName" type="text" placeholder="Nuevo/renombrar sala‚Ä¶">
        <button id="roomAdd" class="small">A√±adir</button>
        <button id="roomRename" class="small ghost">Renombrar</button>
        <button id="roomDelete" class="small ghost">Eliminar</button>
      </div>
    </div>
  </div>

  <!-- LISTA USUARIOS (ADMIN) -->
  <div id="usersBox" class="users"></div>

  <!-- CHAT -->
  <div id="chatBox" class="chat">
    <div id="scroll" class="scroll">
      <div id="welcome" class="welcome">üëã Bienvenido. A√∫n no hay mensajes. Este aviso desaparecer√° en cuanto se publique alguno.</div>
      <div id="msgs"></div>
    </div>
    <div class="composer">
      <input id="inpMsg" type="text" placeholder="Escribe un mensaje‚Ä¶">
      <input id="inpTo" type="number" min="1" placeholder="Privado: @n¬∫ (opcional)" style="max-width:140px">
      <button id="btnSend">Enviar</button>
    </div>
    <div id="hint" class="hint">P√∫blico por defecto ¬∑ Privados: escribe destino en ‚ÄúPrivado‚Äù</div>
  </div>

</div>

<!-- Firebase SDK (modular) -->
<script type="module">
/* ------------------ CONFIG ------------------ */
const ADMIN_PASSWORD = "131215";      // Admin (usuario 0) solo contrase√±a
const AUTO_EVERY_MIN = 10;            // intervalo mensajes autom√°ticos
const DEFAULT_ROOM = "xcode";         // sala por defecto

/* Tu proyecto (mantenemos el que usas) */
import { initializeApp } from "https://www.gstatic.com/firebasejs/10.12.2/firebase-app.js";
import {
  getDatabase, ref, child, get, set, update, onValue, push, serverTimestamp
} from "https://www.gstatic.com/firebasejs/10.12.2/firebase-database.js";

const firebaseConfig = {
  apiKey: "AIzaSyD66wsrvZmQmzmp0htKmrxCbFwOmeijqiQ",
  authDomain: "x-code-chat.firebaseapp.com",
  databaseURL: "https://x-code-chat-default-rtdb.europe-west1.firebasedatabase.app",
  projectId: "x-code-chat",
  storageBucket: "x-code-chat.firebasestorage.app",
  messagingSenderId: "819845037951",
  appId: "1:819845037951:web:f0fe8971356afb2f66a44a"
};
const app = initializeApp(firebaseConfig);
const db  = getDatabase(app);

/* ------------------ UI refs ------------------ */
const loginBox  = document.getElementById('loginBox');
const chatBox   = document.getElementById('chatBox');
const usersBox  = document.getElementById('usersBox');
const inpNumber = document.getElementById('inpNumber');
const inpPin    = document.getElementById('inpPin');
const btnEnter  = document.getElementById('btnEnter');
const btnSend   = document.getElementById('btnSend');
const inpMsg    = document.getElementById('inpMsg');
const inpTo     = document.getElementById('inpTo');
const msgsEl    = document.getElementById('msgs');
const welcomeEl = document.getElementById('welcome');
const scrollEl  = document.getElementById('scroll');
const roomName  = document.getElementById('roomName');
const loginHelp = document.getElementById('loginHelp');

const adminBar  = document.getElementById('adminBar');
const btnAdminOn  = document.getElementById('btnAdminOn');
const btnAdminOff = document.getElementById('btnAdminOff');
const btnAuto     = document.getElementById('btnAuto');
const btnGlobal   = document.getElementById('btnGlobalMsg');

const roomLine  = document.getElementById('roomLine');
const selRoom   = document.getElementById('selRoom');
const roomNew   = document.getElementById('roomNewName');
const roomAdd   = document.getElementById('roomAdd');
const roomRen   = document.getElementById('roomRename');
const roomDel   = document.getElementById('roomDelete');

/* ------------------ Estado ------------------ */
let state = {
  room: localStorage.getItem('xchat_room') || DEFAULT_ROOM,
  me:   null,         // n√∫mero o '0' para admin
  pin:  null,
  role: null,         // 'user' | 'admin'
  autoTimer: null,
  welcomeHidden: false
};
roomName.textContent = titleCase(state.room);

/* ------------------ Util ------------------ */
function titleCase(s){ return s.replace(/[-_]/g,' ').replace(/\b\w/g,m=>m.toUpperCase()); }
function uid(){ return Math.random().toString(36).slice(2); }
function stickScroll(){
  setTimeout(()=>{ scrollEl.scrollTop = scrollEl.scrollHeight; }, 20);
}
function show(el, on){ el.style.display = on ? (el.classList.contains('chat')?'flex':'block') : 'none'; }
function setRole(role){
  state.role = role;
  const isAdmin = role==='admin';
  show(adminBar, isAdmin);
  show(roomLine, isAdmin);
  show(usersBox, isAdmin);
}

/* --------- Persistencia (no perder sesi√≥n al refrescar) ---------- */
function saveSession(){
  localStorage.setItem('xchat_room', state.room);
  localStorage.setItem('xchat_num',  state.me ?? '');
  localStorage.setItem('xchat_pin',  state.pin ?? '');
  localStorage.setItem('xchat_role', state.role ?? '');
}
function loadSession(){
  const r = localStorage.getItem('xchat_room') || DEFAULT_ROOM;
  const n = localStorage.getItem('xchat_num');
  const p = localStorage.getItem('xchat_pin');
  const role = localStorage.getItem('xchat_role');
  state.room = r; roomName.textContent = titleCase(r);
  if(n && role){
    state.me=n; state.pin=p; state.role=role;
    if(role==='admin'){ enterAdminUI(); }
    enterChatUI();
    attachRealtime();
  }
}
loadSession();

/* ------------------ Rooms (solo admin) ------------------ */
async function refreshRooms(){
  const snap = await get(ref(db,'roomsMeta'));
  selRoom.innerHTML = '';
  if(snap.exists()){
    const meta = snap.val();
    for(const id of Object.keys(meta)){
      const opt = document.createElement('option');
      opt.value=id; opt.textContent = meta[id].name||id;
      selRoom.appendChild(opt);
    }
  }
  // asegurar sala actual en selector:
  let found = [...selRoom.options].some(o=>o.value===state.room);
  if(!found){
    const opt = document.createElement('option');
    opt.value=state.room; opt.textContent=titleCase(state.room);
    selRoom.appendChild(opt);
  }
  selRoom.value = state.room;
}
async function setRoom(id){
  state.room = id;
  roomName.textContent = titleCase(id);
  saveSession();
  detachRealtime();
  clearChatUI();
  attachRealtime();
}
roomAdd.onclick = async ()=>{
  const name = (roomNew.value||'').trim(); if(!name) return;
  await update(ref(db,'roomsMeta/'+name), {name});
  roomNew.value='';
  refreshRooms();
};
roomRen.onclick = async ()=>{
  const name = (roomNew.value||'').trim(); if(!name) return;
  await update(ref(db,'roomsMeta/'+state.room), {name});
  refreshRooms();
};
roomDel.onclick = async ()=>{
  const id = selRoom.value;
  if(!confirm(`Eliminar sala "${id}"? Esto no borra mensajes, solo el nombre.`)) return;
  await set(ref(db,'roomsMeta/'+id), null);
  refreshRooms();
};
selRoom.onchange = ()=> setRoom(selRoom.value);

/* ------------------ Login ------------------ */
btnEnter.onclick = async ()=>{
  const num = String((inpNumber.value||'').trim());
  const pin = String((inpPin.value||'').trim());

  if(!num){ alert('Introduce tu n√∫mero'); return; }

  if(num==='0'){ // ADMIN (solo contrase√±a)
    if(pin!==ADMIN_PASSWORD){ alert('Contrase√±a incorrecta'); return; }
    state.me='0'; state.pin=''; setRole('admin'); saveSession(); enterAdminUI();
    enterChatUI(); attachRealtime(); refreshRooms();
    return;
  }

  // Usuario normal
  const uref = ref(db, `rooms/${state.room}/users/${num}`);
  const snap = await get(uref);
  if(!snap.exists()){
    // primera vez => generar PIN
    const newPin = (''+Math.floor(1000+Math.random()*9000));
    await set(uref, { pin:newPin, active:true, createdAt: Date.now() });
    alert(`Tu PIN es: ${newPin} (gu√°rdalo)`);
    state.me=num; state.pin=newPin; setRole('user'); saveSession();
    enterChatUI(); attachRealtime();
  }else{
    const data = snap.val();
    if(!pin){ alert('PIN faltante. P√≠dele tu PIN al organizador.'); return; }
    if(pin!==String(data.pin)){ alert('PIN incorrecto.'); return; }
    if(data.active===false){ alert('Tu acceso est√° desactivado por el organizador.'); return; }
    state.me=num; state.pin=pin; setRole('user'); saveSession();
    enterChatUI(); attachRealtime();
  }
};

/* Panel admin botones */
function enterAdminUI(){
  adminBar.querySelector('.pill').textContent = 'Conectado como admin';
  btnAdminOn.disabled = true;
  btnAdminOff.disabled = false;
  show(usersBox,true);
  show(roomLine,true);
}
btnAdminOn.onclick = ()=> enterAdminUI();
btnAdminOff.onclick = ()=>{
  setRole(null);
  show(usersBox,false); show(roomLine,false);
};

/* ------------------ Chat runtime ------------------ */
let msgsOff = null, usersOff = null;

function detachRealtime(){
  if(msgsOff) msgsOff(); msgsOff=null;
  if(usersOff) usersOff(); usersOff=null;
}
function clearChatUI(){
  msgsEl.innerHTML='';
  state.welcomeHidden=false;
  show(welcomeEl,true);
}

function enterChatUI(){
  show(chatBox,true);
  // centrar login visualmente (pero mantenerlo por si admin)
  document.getElementById('loginBox').scrollIntoView({block:'start'});
}

/* Suscripciones */
function attachRealtime(){
  // mensajes
  const mref = ref(db, `rooms/${state.room}/messages`);
  msgsOff = onValue(mref, (snap)=>{
    msgsEl.innerHTML='';
    const list=[];
    if(snap.exists()){
      const v = snap.val();
      for(const k of Object.keys(v)) list.push(v[k]);
      list.sort((a,b)=> (a.ts||0)-(b.ts||0));
    }
    if(list.length>0 && !state.welcomeHidden){ show(welcomeEl,false); state.welcomeHidden=true; }
    for(const m of list){
      const isMe = String(m.from)===String(state.me);
      const div = document.createElement('div');
      div.className = 'bubble'+(isMe?' me':'')+(m.system?' system':'');
      div.innerHTML = m.text.replace(/\n/g,'<br>');
      const meta = document.createElement('div');
      meta.className='meta';
      const t = new Date(m.ts||Date.now());
      meta.textContent = (m.system?'¬∑ Sistema ¬∑ ': `#${m.from}`)+(m.to?` ‚Üí @${m.to}`:'')+
                         ` ¬∑ ${String(t.getHours()).padStart(2,'0')}:${String(t.getMinutes()).padStart(2,'0')}`;
      div.appendChild(meta);
      msgsEl.appendChild(div);
    }
    stickScroll();
  });

  // usuarios (solo admin ve la tabla y PIN)
  if(state.role==='admin'){
    const uref = ref(db, `rooms/${state.room}/users`);
    usersOff = onValue(uref, (snap)=>{
      usersBox.innerHTML = '<div class="sub" style="margin-bottom:6px">Usuarios (PIN visible solo para admin)</div>';
      if(!snap.exists()){ usersBox.innerHTML += '<div class="status">Sin usuarios a√∫n.</div>'; return; }
      const v = snap.val();
      const ids = Object.keys(v).sort((a,b)=>Number(a)-Number(b));
      for(const id of ids){
        const u = v[id];
        const row = document.createElement('div');
        row.className='userRow';
        row.innerHTML = `
          <div>#${id}</div>
          <div class="status">PIN: <b>${u.pin||'‚Äî'}</b> ¬∑ ${u.active===false?'<span style="color:#ffbebe">Desactivado</span>':'Activo'}</div>
          <button class="small ghost" data-act="${u.active===false?'activar':'desactivar'}" data-id="${id}">
            ${u.active===false?'Activar':'Desactivar'}
          </button>
          <button class="small" data-kick="${id}">Desconectar</button>
        `;
        usersBox.appendChild(row);
      }
      // eventos
      usersBox.querySelectorAll('button[data-act]').forEach(btn=>{
        btn.onclick = async ()=>{
          const id = btn.getAttribute('data-id');
          const act = btn.getAttribute('data-act');
          await update(ref(db, `rooms/${state.room}/users/${id}`), {active: (act==='activar')});
        };
      });
      usersBox.querySelectorAll('button[data-kick]').forEach(btn=>{
        btn.onclick = async ()=>{
          const id = btn.getAttribute('data-kick');
          await update(ref(db, `rooms/${state.room}/users/${id}`), {lastKicked: Date.now()});
          alert(`Usuario ${id} marcado como desconectado.`);
        };
      });
    });
  }else{
    show(usersBox,false);
  }
}

/* Enviar mensaje */
btnSend.onclick = async ()=>{
  const txt = (inpMsg.value||'').trim();
  const to  = (inpTo.value||'').trim();
  if(!txt) return;
  // valida usuario activo (si existe registro y active=false bloquea env√≠o)
  if(state.me!=='0'){
    const snap = await get(ref(db, `rooms/${state.room}/users/${state.me}`));
    if(snap.exists() && snap.val().active===false){ alert('No puedes enviar mensajes: est√°s desactivado.'); return; }
  }
  const m = {
    id: uid(), from: state.me, to: to?to:null, text: txt, ts: Date.now(), system:false
  };
  await set(ref(db, `rooms/${state.room}/messages/${m.id}`), m);
  inpMsg.value=''; inpTo.value='';
  stickScroll();
};

/* Mensaje global (admin) */
btnGlobal.onclick = async ()=>{
  if(state.role!=='admin') return;
  const txt = prompt("Mensaje global (aparecer√° para todos):");
  if(!txt) return;
  const m = { id: uid(), from:'ORG', to:null, text: txt, ts: Date.now(), system:true };
  await set(ref(db, `rooms/${state.room}/messages/${m.id}`), m);
};

/* Mensajes autom√°ticos ON/OFF (solo cuando admin pulsa activar) */
btnAuto.onclick = ()=>{
  if(state.role!=='admin') return;
  const isOn = !!state.autoTimer;
  if(isOn){
    clearInterval(state.autoTimer); state.autoTimer=null;
    btnAuto.textContent = 'Mensajes auto: OFF';
    alert('Mensajes autom√°ticos desactivados');
  }else{
    const ms = AUTO_EVERY_MIN*60*1000;
    state.autoTimer = setInterval(async ()=>{
      const tips = [
        'Consejo: usa @n√∫mero para enviar privado.',
        'Recuerda ser respetuoso: el chat es parte de la experiencia.',
        'Si tienes dudas, escribe @0 para contactar al organizador.',
        'Tip: deslizad hacia arriba para revisar mensajes anteriores.'
      ];
      const txt = tips[Math.floor(Math.random()*tips.length)];
      const m = { id: uid(), from:'ORG', text: txt, ts: Date.now(), system:true };
      await set(ref(db, `rooms/${state.room}/messages/${m.id}`), m);
    }, ms);
    btnAuto.textContent = 'Mensajes auto: ON';
    alert(`Mensajes autom√°ticos ACTIVADOS cada ${AUTO_EVERY_MIN} min`);
  }
};

/* ------------------ Ajustes de UX ------------------ */
inpNumber.addEventListener('input', ()=>{
  // Si escribe 0, el segundo campo act√∫a como "contrase√±a"
  if(String(inpNumber.value).trim()==='0'){
    inpPin.type='password';
    inpPin.placeholder='Contrase√±a admin';
    loginHelp.textContent = 'Acceso admin: usa el n√∫mero 0 y la contrase√±a.';
  }else{
    inpPin.type='password';
    inpPin.placeholder='Tu PIN (si ya tienes)';
    loginHelp.innerHTML = 'Acceso con <b>n√∫mero</b> y <b>PIN</b>. Si es tu primer acceso, el PIN se genera autom√°ticamente.';
  }
});

/* ------------------ Inicio ------------------ */
(async function boot(){
  // asegura meta de salas y pinta selector si admin
  try{ await refreshRooms(); }catch(e){}
})();
</script>
</body>
</html>
