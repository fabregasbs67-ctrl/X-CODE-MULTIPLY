<!DOCTYPE html>
<html lang="es">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0">
  <title>X Code Chat â€” Official</title>
  <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;600&display=swap" rel="stylesheet">
  <style>
    :root{ --bg:#000; --fg:#fff; --gold1:#f1d27a; --gold2:#b58e2b; }
    *{box-sizing:border-box}
    html,body{margin:0;height:100%;background:var(--bg);color:var(--fg);font-family:'Inter',system-ui,-apple-system,Segoe UI,Roboto,Arial,sans-serif}
    /* Header minimal */
    .header{display:flex;align-items:center;gap:12px;padding:14px 16px;position:sticky;top:0;background:#000;z-index:10;border-bottom:1px solid #111}
    .logo{width:34px;height:auto;flex:0 0 auto}
    .ttl{margin:0; font-size:18px; font-weight:600; line-height:1.1}
    .sub{font-size:12px;opacity:.9}
    .sp{flex:1}
    .btn{appearance:none;border:none;border-radius:10px;padding:10px 14px;font-weight:600;cursor:pointer}
    .btn-primary{background:#fff;color:#000}
    .btn-ghost{background:transparent;color:#fff;border:1px solid #fff}
    .input, .pin, .text{width:100%;padding:12px 14px;border:1px solid #fff;border-radius:10px;background:#000;color:#fff;font-size:16px}
    /* Login centrado vertical y horizontal */
    .login-wrap{min-height:calc(100vh - 64px);display:flex;align-items:center;justify-content:center;padding:16px}
    .login{display:flex;flex-direction:column;gap:12px;max-width:720px;width:100%}
    .row{display:grid;grid-template-columns:1fr 1fr;gap:10px}
    @media (max-width:560px){ .row{grid-template-columns:1fr} }
    .actions{display:flex;gap:8px;flex-wrap:wrap}
    .help{font-size:12px;opacity:.9}
    .err{color:#ff6b6b} .ok{color:#00ffa3}
    /* Chat */
    .chat{display:flex;flex-direction:column;gap:0;max-width:860px;margin:0 auto;padding:0 12px 16px 12px}
    .banner{display:none; text-align:center; padding:10px 12px; margin-top:10px; border:1px solid #fff; border-radius:10px}
    .list{flex:1;overflow:auto;display:flex;flex-direction:column;gap:8px;padding:12px 0;min-height:60vh}
    .msg{max-width:85%;border:1px solid #fff;border-radius:12px;padding:8px 12px;line-height:1.4;font-size:15px;word-wrap:break-word;background:#000}
    .me{align-self:flex-end;background:#111}
    .other{align-self:flex-start}
    .org{border-color:var(--gold1)}
    .meta{font-size:11px;opacity:.8;margin-top:4px}
    .compose{display:flex;gap:8px;padding:10px 0;position:sticky;bottom:0;background:#000}
    .hint{font-size:12px;opacity:.85;text-align:center;padding:6px 0}
    /* Admin panel (solo organizador) */
    #adminPanel{max-width:860px;margin:0 auto;padding:10px 12px 16px 12px;border-top:1px solid #111}
    #usersTable table{width:100%;border-collapse:collapse;color:#fff;font-size:14px}
    #usersTable th,#usersTable td{border-bottom:1px solid #222;padding:6px;text-align:left}
    .admin-controls{display:flex;gap:8px;flex-wrap:wrap;align-items:center;margin:10px 0}
    .small{font-size:12px;opacity:.85}
  </style>
</head>
<body>
  <!-- HEADER -->
  <div class="header">
    <img src="images/logo.png" class="logo" alt="X Code Logo" onerror="this.style.display='none';document.getElementById('fallbackLogo').style.display='block'">
    <svg id="fallbackLogo" class="logo" viewBox="0 0 100 100" style="display:none" xmlns="http://www.w3.org/2000/svg" aria-hidden="true">
      <defs><linearGradient id="g1" x1="0" x2="1" y1="0" y2="1"><stop offset="0%" stop-color="#f1d27a"/><stop offset="100%" stop-color="#b58e2b"/></linearGradient></defs>
      <circle cx="50" cy="50" r="40" fill="none" stroke="url(#g1)" stroke-width="5"/>
      <path d="M35 28 L50 50 L65 72 M65 28 L50 50 L35 72" stroke="url(#g1)" stroke-width="7" stroke-linecap="round" fill="none"/>
    </svg>
    <div>
      <h1 class="ttl">X Code Chat â€” Official</h1>
      <div class="sub" id="youAreTop">Sala: X Code</div>
    </div>
    <div class="sp"></div>
    <button id="logoutBtn" class="btn btn-ghost" style="display:none">Salir</button>
  </div>

  <!-- LOGIN -->
  <section id="loginWrap" class="login-wrap">
    <div id="loginView" class="login">
      <div class="help">Acceso con <b>nÃºmero</b> y <b>PIN</b>. Si es tu primer acceso, el PIN se genera automÃ¡ticamente. (Organizador: usa el nÃºmero <b>0</b> y contraseÃ±a).</div>
      <div class="row">
        <input id="codeInput" class="input" type="number" min="0" max="320" placeholder="Tu nÃºmero (ej. 70)">
        <input id="pinInput" class="pin" type="number" inputmode="numeric" placeholder="Tu PIN (si ya tienes)">
      </div>
      <div id="loginMsg" class="help"></div>
      <div class="actions">
        <button id="enterBtn" class="btn btn-primary">Entrar</button>
        <button id="showPinBtn" class="btn btn-ghost">Mostrar mi PIN</button>
      </div>
    </div>
  </section>

  <!-- CHAT -->
  <section id="chatView" class="chat" style="display:none">
    <div id="welcomeBanner" class="banner">âœ¨ Bienvenido a X Code Chat â€” Official âœ¨</div>
    <div class="list" id="list"></div>
    <div class="compose">
      <input id="textInput" class="text" type="text" placeholder="Escribe un mensajeâ€¦ Â· Privado: @120 hola">
      <button id="sendBtn" class="btn btn-ghost">Enviar</button>
    </div>
    <div class="hint">PÃºblico: escribe normal Â· Privado: <b>@120 hola</b> (solo lo verÃ¡ el 120)</div>
  </section>

  <!-- ADMIN: solo visible para organizador (nÃºmero 0) -->
  <section id="adminPanel" style="display:none">
    <h3 style="margin:0 0 6px 0">Panel del organizador</h3>
    <div id="adminMsg" class="small"></div>

    <div class="admin-controls">
      <div class="small">Mensajes automÃ¡ticos cada</div>
      <input id="autoEvery" type="number" class="input" style="max-width:90px" min="1" value="10">
      <div class="small">min</div>
      <button id="autoStart" class="btn btn-primary">Activar</button>
      <button id="autoStop" class="btn btn-ghost">Pausar</button>
    </div>

    <div class="admin-controls" style="margin-top:0">
      <input id="orgText" class="text" placeholder="Mensaje global (aparecerÃ¡ para todos)">
      <button id="orgSend" class="btn btn-primary">Publicar</button>
    </div>

    <div id="usersTable" style="max-height:260px; overflow:auto; margin-top:10px;"></div>
  </section>

<script type="module">
  import { initializeApp } from 'https://www.gstatic.com/firebasejs/9.6.1/firebase-app.js';
  import { getDatabase, ref, get, set, push, onChildAdded, query, limitToLast, onDisconnect, remove, update } from 'https://www.gstatic.com/firebasejs/9.6.1/firebase-database.js';

  // Firebase config (tu proyecto)
  const firebaseConfig = {
    apiKey: "AIzaSyD66wsrvZmQmzmp0htKmrxCbFwOmeijqiQ",
    authDomain: "x-code-chat.firebaseapp.com",
    databaseURL: "https://x-code-chat-default-rtdb.europe-west1.firebasedatabase.app",
    projectId: "x-code-chat",
    storageBucket: "x-code-chat.firebasestorage.app",
    messagingSenderId: "819845037951",
    appId: "1:819845037951:web:f0fe8971356afb2f66a44a"
  };

  const app = initializeApp(firebaseConfig);
  const db = getDatabase(app);

  const EVENT_ID = "primera_edicion_x_code";
  const MIN = 0, MAX = 320; // 0 = organizador
  const ADMIN_PASSWORD = "131215";

  // UI
  const loginWrap = document.getElementById('loginWrap');
  const loginView = document.getElementById('loginView');
  const chatView  = document.getElementById('chatView');
  const codeInput = document.getElementById('codeInput');
  const pinInput  = document.getElementById('pinInput');
  const loginMsg  = document.getElementById('loginMsg');
  const enterBtn  = document.getElementById('enterBtn');
  const showPinBtn= document.getElementById('showPinBtn');

  const youAreTop = document.getElementById('youAreTop');
  const list      = document.getElementById('list');
  const textInput = document.getElementById('textInput');
  const sendBtn   = document.getElementById('sendBtn');
  const logoutBtn = document.getElementById('logoutBtn');
  const welcomeBanner = document.getElementById('welcomeBanner');

  // Admin UI
  const adminPanel = document.getElementById('adminPanel');
  const adminMsg   = document.getElementById('adminMsg');
  const usersTable = document.getElementById('usersTable');
  const orgText    = document.getElementById('orgText');
  const orgSend    = document.getElementById('orgSend');
  const autoEvery  = document.getElementById('autoEvery');
  const autoStart  = document.getElementById('autoStart');
  const autoStop   = document.getElementById('autoStop');

  // Estado
  let myCode = null;
  let myPIN  = null;
  let mySessionId = null;
  let isOrganizer = false;
  let autoTimer = null;

  // Helpers
  const validCode = n => Number.isInteger(n) && n>=MIN && n<=MAX;
  const rndPIN = () => String(Math.floor(1000 + Math.random()*9000)); // 4 dÃ­gitos
  const pinKey  = c => `xcode_pin_${EVENT_ID}_${c}`;
  const sessKey = c => `xcode_session_${EVENT_ID}_${c}`;

  // Auto-login si hay datos
  (function tryAuto(){
    const storedCode = localStorage.getItem('xcode_current_code');
    const storedPin  = storedCode ? localStorage.getItem(pinKey(storedCode)) : null;
    const storedSess = storedCode ? localStorage.getItem(sessKey(storedCode)) : null;
    if(storedCode && storedPin){
      myCode = parseInt(storedCode,10);
      myPIN  = storedPin;
      mySessionId = storedSess || null;
      startLoginFlow(true).catch(()=>{});
    }
  })();

  enterBtn.addEventListener('click', ()=> startLoginFlow(false));

  async function startLoginFlow(isAuto){
    loginMsg.textContent = '';
    const code = isAuto ? myCode : parseInt(codeInput.value,10);
    const pin  = isAuto ? myPIN  : (pinInput.value.trim() || null);

    if(!validCode(code)){
      loginMsg.textContent='CÃ³digo no vÃ¡lido (0â€“320).'; loginMsg.classList.add('err'); return;
    }

    // Si es organizador (0), pedir contraseÃ±a admin (solo primer intento manual)
    if(code === 0 && !isAuto){
      const pass = prompt('ContraseÃ±a de organizador:');
      if(pass !== ADMIN_PASSWORD){ loginMsg.textContent='ContraseÃ±a admin incorrecta.'; loginMsg.classList.add('err'); return; }
      isOrganizer = true;
    }

    const uRef = ref(db, `rooms/${EVENT_ID}/usuarios/${code}`);
    const snap = await get(uRef);

    if(!snap.exists()){
      // Primer acceso â†’ generar PIN y NO entrar aÃºn (mostrarlo primero)
      const newPIN = rndPIN();
      await set(uRef, { pin:newPIN, createdAt: Date.now(), welcomeShown: (code===0?true:false) });
      myPIN = newPIN;
      myCode = code;
      localStorage.setItem('xcode_current_code', String(code));
      localStorage.setItem(pinKey(code), newPIN);
      loginMsg.innerHTML = `Tu PIN es <b>${newPIN}</b>. Se ha guardado en este dispositivo.<br>Vuelve a pulsar <b>Entrar</b> para acceder.`;
      loginMsg.classList.remove('err');
      return;
    } else {
      // Usuario existe: validar PIN (introducido o del dispositivo)
      const data = snap.val();
      const expectedPIN = String(data.pin || '');
      const candidatePIN = pin || localStorage.getItem(pinKey(code));
      if(code !== 0 && (!candidatePIN || String(candidatePIN)!==expectedPIN)){
        loginMsg.textContent='PIN incorrecto o faltante. Pide tu PIN al organizador.';
        loginMsg.classList.add('err');
        return;
      }
      myPIN = (code===0 ? 'ORG' : expectedPIN); myCode = code;
      localStorage.setItem('xcode_current_code', String(code));
      if(code!==0) localStorage.setItem(pinKey(code), expectedPIN);
      await createSessionOrFail(code);
      await openChat(data);
    }
  }

  async function createSessionOrFail(code){
    const sBase = ref(db, `rooms/${EVENT_ID}/activeSessions/${code}`);
    const curr = await get(sBase);
    if(curr.exists()){
      const data = curr.val();
      const existingId = data.sessionId;
      const localId = localStorage.getItem(sessKey(code));
      if(existingId && localId && existingId===localId){ mySessionId = existingId; return; }
      loginMsg.textContent='Este nÃºmero ya estÃ¡ en uso ahora mismo. Intenta mÃ¡s tarde.';
      loginMsg.classList.add('err');
      throw new Error('locked');
    }
    const newId = `${code}-${Date.now()}-${Math.random().toString(36).slice(2,8)}`;
    await set(sBase, { sessionId:newId, since: Date.now() });
    try { onDisconnect(sBase).remove(); } catch(e){}
    mySessionId = newId;
    localStorage.setItem(sessKey(code), newId);
  }

  async function openChat(userData){
    // UI
    loginWrap.style.display='none';
    chatView.style.display='block';
    logoutBtn.style.display='inline-block';
    youAreTop.textContent = `Sala: X Code Â· Tu cÃ³digo: ${myCode}`;

    // Banner de bienvenida solo la primera vez (no para organizador)
    if(myCode !== 0){
      const welcome = userData && userData.welcomeShown ? true : false;
      if(!welcome){
        welcomeBanner.style.display = 'block';
        setTimeout(()=>{ welcomeBanner.style.display='none'; }, 4500);
        // marcar como mostrado
        try {
          await update(ref(db, `rooms/${EVENT_ID}/usuarios/${myCode}`), { welcomeShown: true });
        } catch(e) { /* noop */ }
      }
    }

    // Mostrar panel admin solo para organizador
    if(myCode === 0 || isOrganizer){
      adminPanel.style.display='block';
      adminMsg.textContent = 'Conectado como organizador';
      await loadAllUsersForAdmin();
    } else {
      adminPanel.style.display='none';
    }

    subscribeMessages();
  }

  // Mostrar PIN del usuario actual (si existe en el dispositivo)
  showPinBtn.addEventListener('click', ()=>{
    const stored = localStorage.getItem('xcode_current_code');
    const storedPin = stored ? localStorage.getItem(pinKey(stored)) : null;
    if(!stored || !storedPin){ loginMsg.textContent = 'No hay PIN guardado en este dispositivo.'; loginMsg.classList.add('err'); return; }
    loginMsg.innerHTML = `Tu PIN es <b>${storedPin}</b>.`;
    loginMsg.classList.remove('err');
  });

  // Escucha de mensajes (Ãºltimos 200)
  function subscribeMessages(){
    const messagesRef = query(ref(db, `rooms/${EVENT_ID}/messages`), limitToLast(200));
    onChildAdded(messagesRef, (snap)=> renderMsg(snap.val()));
  }

  // Render con soporte a privados (@nÃºmero) y mensajes de organizador
  function renderMsg(m){
    const isMine = String(m.code)===String(myCode);
    const isToMe = m.to && String(m.to)===String(myCode);
    const isOrg = m.org === true;

    if(!isOrg && m.to && !isToMe && !isMine) return;

    const el = document.createElement('div');
    el.className = 'msg ' + (isOrg ? 'org' : (isMine ? 'me' : 'other'));
    const time = m.time ? new Date(m.time).toLocaleTimeString([], {hour:'2-digit', minute:'2-digit'}) : '';
    const tag = isOrg ? ' Â· Organizador' : (m.to ? ` Â· Privado â†’ #${m.to}` : '');
    el.innerHTML = `<div>${(m.text||'').replace(/</g,'&lt;')}</div>
                    <div class="meta">#${m.code||'ORG'} Â· ${time}${tag}</div>`;
    list.appendChild(el);
    list.scrollTop = list.scrollHeight;
  }

  function parsePrivateTarget(txt){
    const m = txt.match(/^@(\d+)\s+(.*)$/);
    if(!m) return null;
    const num = parseInt(m[1],10);
    if(!(num>=1 && num<=MAX)) return null;
    return { to:num, text:m[2] };
  }

  async function send(){
    const raw = textInput.value.trim();
    if(!raw) return;
    const parsed = parsePrivateTarget(raw);
    const payload = parsed
      ? { code: myCode, text: parsed.text, to: parsed.to, time: Date.now() }
      : { code: myCode, text: raw, time: Date.now(), to: null };
    await push(ref(db, `rooms/${EVENT_ID}/messages`), payload);
    textInput.value='';
  }

  sendBtn.addEventListener('click', send);
  textInput.addEventListener('keydown', e=>{ if(e.key==='Enter') send(); });

  // --- ADMIN ----
  async function loadAllUsersForAdmin(){
    usersTable.innerHTML = 'Cargando...';
    const usersSnap = await get(ref(db, `rooms/${EVENT_ID}/usuarios`));
    if(!usersSnap.exists()){ usersTable.innerHTML = '<i>No hay usuarios</i>'; return; }
    const data = usersSnap.val();
    let html = '<table><thead><tr><th>#</th><th>PIN</th><th>AcciÃ³n</th></tr></thead><tbody>';
    for(const key of Object.keys(data).sort((a,b)=>parseInt(a)-parseInt(b))){
      const pin = data[key].pin || '';
      html += `<tr><td>${key}</td><td>${pin}</td>
               <td><button data-k="${key}" class="btn btn-ghost adminDisconnect">Desconectar</button></td></tr>`;
    }
    html += '</tbody></table>';
    usersTable.innerHTML = html;

    document.querySelectorAll('.adminDisconnect').forEach(btn=>{
      btn.addEventListener('click', async (e)=>{
        const k = e.currentTarget.dataset.k;
        await remove(ref(db, `rooms/${EVENT_ID}/activeSessions/${k}`));
        adminMsg.textContent = `SesiÃ³n #${k} desconectada (si existÃ­a).`;
        await loadAllUsersForAdmin();
      });
    });
  }

  // Mensaje global de organizador
  orgSend.addEventListener('click', async ()=>{
    const txt = orgText.value.trim();
    if(!txt) return;
    await push(ref(db, `rooms/${EVENT_ID}/messages`), { code: 0, text: txt, time: Date.now(), org: true });
    orgText.value='';
  });

  // Mensajes automÃ¡ticos (activaciÃ³n manual)
  autoStart.addEventListener('click', ()=>{
    const mins = Math.max(1, parseInt(autoEvery.value||'10',10));
    if(autoTimer) clearInterval(autoTimer);
    autoTimer = setInterval(async ()=>{
      const autoTxt = 'ðŸ”” Recordatorio: mantÃ©n viva la quÃ­mica. Descubre tu match con respeto y misterio.';
      await push(ref(db, `rooms/${EVENT_ID}/messages`), { code: 0, text: autoTxt, time: Date.now(), org: true });
    }, mins*60*1000);
    adminMsg.textContent = `Mensajes automÃ¡ticos activados cada ${mins} min.`;
  });

  autoStop.addEventListener('click', ()=>{
    if(autoTimer) clearInterval(autoTimer);
    autoTimer = null;
    adminMsg.textContent = 'Mensajes automÃ¡ticos pausados.';
  });

  // Logout
  logoutBtn.addEventListener('click', async ()=>{
    try{ await remove(ref(db, `rooms/${EVENT_ID}/activeSessions/${myCode}`)); }catch(e){}
    localStorage.removeItem('xcode_current_code');
    localStorage.removeItem(pinKey(myCode));
    localStorage.removeItem(sessKey(myCode));
    location.reload();
  });
</script>
</body>
</html>
