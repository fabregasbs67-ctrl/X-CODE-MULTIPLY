<!DOCTYPE html>
<html lang="es">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1, viewport-fit=cover" />
  <title>X Code Chat ‚Äî Official</title>
  <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;600&display=swap" rel="stylesheet">
  <style>
    :root{
      --bg:#000; --fg:#fff; --muted:#bfbfbf;
      --card:#0b0b0b; --line:#2a2a2a;
      --ok:#2ecc71; --danger:#ff4d4d;
    }
    *{box-sizing:border-box}
    html,body{height:100%}
    body{margin:0;background:var(--bg);color:var(--fg);font-family:Inter,system-ui,Roboto,Arial,sans-serif}
    .wrap{min-height:100svh;display:flex;flex-direction:column;gap:12px;padding:12px}
    .card{background:var(--card);border:1px solid var(--line);border-radius:14px;padding:14px}
    .header{display:flex;align-items:center;gap:12px;justify-content:space-between}
    .brand{display:flex;align-items:center;gap:10px}
    .logo{width:28px;height:28px;border-radius:50%;background:#111;border:1px solid var(--line);overflow:hidden}
    .logo img{width:100%;height:100%;display:block;object-fit:cover}
    .ttl{font-weight:700;font-size:20px}
    .sub{font-size:12px;color:var(--muted)}
    .btn{appearance:none;border:1px solid #fff;background:#fff;color:#000;border-radius:12px;padding:10px 14px;font-weight:600;cursor:pointer}
    .btn.ghost{background:transparent;color:#fff}
    .login{max-width:720px;margin:4svh auto 0;display:flex;flex-direction:column;gap:10px}
    .field{display:flex;align-items:center;gap:8px;border:1px solid var(--line);border-radius:12px;padding:10px;background:#0a0a0a}
    .field input{flex:1;background:transparent;border:none;outline:none;color:var(--fg);font-size:16px}
    .eye{cursor:pointer;user-select:none}
    .hint{color:var(--muted);font-size:13px}
    .chat{max-width:920px;margin:0 auto;padding:0;overflow:hidden}
    .chatHead{display:flex;align-items:center;gap:10px;border-bottom:1px solid var(--line);padding:12px 14px}
    .messages{height:calc(100svh - 260px);min-height:320px;overflow:auto;padding:14px;display:flex;flex-direction:column;gap:8px}
    .bubble{max-width:86%;padding:10px 12px;border:1px solid #3a3a3a;border-radius:14px;background:#0f0f0f;white-space:pre-wrap;word-break:break-word}
    .me{align-self:flex-end;background:#141414;border-color:#555}
    .system{border-style:dashed;color:#e8e8e8}
    .meta{margin-top:6px;font-size:11px;color:#9a9a9a}
    .composer{display:flex;gap:8px;align-items:center;border-top:1px solid var(--line);padding:10px;background:#080808}
    .composer .field{flex:1}
    .admin{display:none;gap:10px;margin:0 auto;max-width:920px}
    .row{display:flex;gap:8px;flex-wrap:wrap;align-items:center}
    .input, .select{height:44px;border-radius:10px;border:1px solid var(--line);background:#0a0a0a;color:#fff;padding:0 12px}
    .userRow{display:grid;grid-template-columns:80px 1fr auto auto;gap:8px;align-items:center;border-top:1px dashed var(--line);padding:8px 0}
    .badge{display:inline-block;padding:2px 8px;border:1px solid #3a3a3a;border-radius:999px;font-size:12px;background:#0a0a0a}
    .toast{position:fixed;left:50%;transform:translateX(-50%);bottom:calc(12px + env(safe-area-inset-bottom,0));background:#111;border:1px solid var(--line);color:#fff;padding:.7rem 1rem;border-radius:12px;display:none;z-index:50}
    .toast.show{display:block}
    @media (max-width:560px){.messages{height:calc(100svh - 290px)}}
  </style>
</head>
<body>
<div class="wrap">

  <!-- Header -->
  <div class="card header">
    <div class="brand">
      <span class="logo"><img id="logo1" alt="X"></span>
      <div>
        <div class="ttl">X Code Chat ‚Äî Official</div>
        <div class="sub">Sala: <span id="roomHdr">Sala de Prueba</span></div>
      </div>
    </div>
    <button id="logoutTop" class="btn ghost" style="display:none">Salir</button>
  </div>

  <!-- Login -->
  <div id="loginCard" class="card login">
    <div class="hint">Acceso con <b>n√∫mero</b> y <b>PIN</b>. En tu primer acceso, el PIN se genera autom√°ticamente.</div>
    <div class="field"><input id="numInput" type="number" inputmode="numeric" placeholder="Tu n√∫mero (ej. 70)"></div>
    <div class="field">
      <input id="pinInput" type="password" inputmode="numeric" placeholder="Tu PIN (si ya tienes)">
      <span id="eyePin" class="eye" title="Mostrar/ocultar PIN">üëÅÔ∏è</span>
    </div>
    <div class="row">
      <button id="loginBtn" class="btn">Entrar</button>
    </div>
    <div id="pinNotice" class="bubble system" style="display:none"></div>
  </div>

  <!-- Chat -->
  <div id="chatCard" class="card chat" style="display:none">
    <div class="chatHead">
      <span class="logo" style="width:22px;height:22px"><img id="logo2" alt=""></span>
      <div>
        <div class="ttl" style="font-size:18px">X Code Chat ‚Äî Official</div>
        <div class="sub">Sala: <span id="roomHdr2">Sala de Prueba</span> ¬∑ Tu c√≥digo: <span id="meCode">-</span></div>
      </div>
      <div style="flex:1"></div>
      <button id="logoutBtn" class="btn ghost">Salir</button>
    </div>
    <div id="messages" class="messages">
      <div id="welcomeBox" class="bubble system">üëã Bienvenido. A√∫n no hay mensajes. Este aviso desaparecer√° en cuanto se publique alguno.</div>
    </div>
    <div class="composer">
      <div class="field"><input id="msgInput" type="text" placeholder="Escribe un mensaje‚Ä¶ ¬∑ Privado con @n√∫mero (ej. @120 hola)"></div>
      <button id="sendBtn" class="btn">Enviar</button>
    </div>
    <div class="hint">P√∫blico por defecto ¬∑ Privado con <b>@n√∫mero</b></div>
  </div>

  <!-- Admin -->
  <div id="adminCard" class="card admin">
    <div class="row">
      <button id="broadcastBtn" class="btn ghost">Mensaje global</button>
      <button id="autoBtn" class="btn ghost">Mensajes auto: <b id="autoState">OFF</b></button>
    </div>
    <div class="row">
      <select id="roomSelect" class="select"></select>
      <input id="newRoom" class="input" placeholder="Nuevo nombre de sala‚Ä¶">
      <button id="useRoom" class="btn">Usar</button>
      <button id="addRoom" class="btn ghost">A√±adir</button>
      <button id="renRoom" class="btn ghost">Renombrar</button>
      <button id="delRoom" class="btn" style="background:var(--danger);border-color:var(--danger);color:#000">Eliminar</button>
    </div>
    <div style="font-weight:600;margin-top:6px">Usuarios <span class="sub">(PIN visible solo para admin)</span></div>
    <div id="usersList"></div>
  </div>

</div>

<div id="toast" class="toast"></div>

<script type="module">
  // ===== CONFIG =====
  const LOGO_URL = "https://raw.githubusercontent.com/fabregasbs67-ctrl/X-CODE-MULTIPLY/main/assets/x_logo_gold.png";
  const ADMIN_PASSWORD = "131215";
  const DEFAULT_ROOM = "Sala de Prueba";

  // Firebase
  import { initializeApp } from "https://www.gstatic.com/firebasejs/10.12.2/firebase-app.js";
  import { getDatabase, ref, get, set, update, remove, push, onChildAdded, onValue } from "https://www.gstatic.com/firebasejs/10.12.2/firebase-database.js";

  const firebaseConfig = {
    apiKey: "AIzaSyD66wsrvZmQmzmp0htKmrxCbFwOmeijqiQ",
    authDomain: "x-code-chat.firebaseapp.com",
    databaseURL: "https://x-code-chat-default-rtdb.europe-west1.firebasedatabase.app",
    projectId: "x-code-chat",
    storageBucket: "x-code-chat.firebasestorage.app",
    messagingSenderId: "819845037951",
    appId: "1:819845037951:web:f0fe8971356afb2f66a44a"
  };
  const app = initializeApp(firebaseConfig);
  const db  = getDatabase(app);

  // ===== DOM =====
  const $ = (q)=>document.querySelector(q);
  const toast = (t,ms=3000)=>{ const x=$("#toast"); x.textContent=t; x.classList.add("show"); setTimeout(()=>x.classList.remove("show"),ms); };

  const logo1=$("#logo1"), logo2=$("#logo2");
  logo1.src=LOGO_URL; logo2.src=LOGO_URL;

  const loginCard=$("#loginCard"), chatCard=$("#chatCard"), adminCard=$("#adminCard");
  const roomHdr=$("#roomHdr"), roomHdr2=$("#roomHdr2"), meCode=$("#meCode");
  const logoutTop=$("#logoutTop"), logoutBtn=$("#logoutBtn");

  const numInput=$("#numInput"), pinInput=$("#pinInput"), eyePin=$("#eyePin"), loginBtn=$("#loginBtn"), pinNotice=$("#pinNotice");

  const messages=$("#messages"), welcomeBox=$("#welcomeBox"), msgInput=$("#msgInput"), sendBtn=$("#sendBtn");

  const broadcastBtn=$("#broadcastBtn"), autoBtn=$("#autoBtn"), autoState=$("#autoState");
  const roomSelect=$("#roomSelect"), newRoom=$("#newRoom"), useRoom=$("#useRoom"), addRoom=$("#addRoom"), renRoom=$("#renRoom"), delRoom=$("#delRoom");
  const usersList=$("#usersList");

  // ===== STATE =====
  const LS_KEY="xcode_chat_session_v1";
  let session = { room: DEFAULT_ROOM, num:null, pin:null, role:"guest" };

  function saveSession(){ localStorage.setItem(LS_KEY, JSON.stringify(session)); }
  function loadSession(){ try{ const raw=localStorage.getItem(LS_KEY); if(raw){ session=JSON.parse(raw); } }catch{} }
  function clearSession(){ localStorage.removeItem(LS_KEY); session={ room: DEFAULT_ROOM, num:null, pin:null, role:"guest" }; }

  function setRoomUI(){ roomHdr.textContent=session.room; roomHdr2.textContent=session.room; }
  setRoomUI();

  function roomRef(path){ return ref(db, `rooms/${session.room}/${path}`); }
  const indexRef = ref(db, "rooms_index");

  function hhmm(ts){ const d=new Date(ts||Date.now()); return String(d.getHours()).padStart(2,"0")+":"+String(d.getMinutes()).padStart(2,"0"); }
  function newPIN(){ return (Math.floor(1000+Math.random()*9000)).toString(); }
  function isAdmin(){ return session.num===0 && session.role==="admin"; }

  // PIN show/hide
  eyePin.addEventListener("click", ()=>{ pinInput.type = (pinInput.type==="password"?"text":"password"); });

  // Ensure index & dropdown
  async function ensureIndex(){
    const s=await get(indexRef); const list=s.exists()?s.val():{};
    if(!list[session.room]){ list[session.room]=true; await set(indexRef, list); }
    fillRooms(list);
  }
  function fillRooms(obj){ roomSelect.innerHTML=""; Object.keys(obj||{}).sort().forEach(k=>{ const o=document.createElement("option"); o.value=k; o.textContent=k; if(k===session.room) o.selected=true; roomSelect.appendChild(o); }); }

  // Login
  async function doLogin(){
    const num = Number((numInput.value||"").trim());
    const pinTyped = (pinInput.value||"").trim();
    if(!(num>=0)) return toast("Introduce tu n√∫mero");

    if(num===0){
      if(pinTyped!==ADMIN_PASSWORD) return toast("Contrase√±a admin incorrecta");
      session.num=0; session.pin=null; session.role="admin"; saveSession();
      afterLogin(); return;
    }

    const uRef = roomRef(`users/${num}`); const uSnap=await get(uRef);
    let pinToUse = pinTyped;

    if(!uSnap.exists()){
      pinToUse = newPIN();
      await set(uRef, { pin: pinToUse, active:true, connected:true, createdAt: Date.now() });
    }else{
      const data=uSnap.val();
      if(!pinToUse){
        const ls = JSON.parse(localStorage.getItem(LS_KEY)||"{}");
        if(ls && ls.room===session.room && ls.num===num && ls.pin){ pinToUse = ls.pin; }
      }
      if(pinToUse!==data.pin){
        pinNotice.style.display="block";
        pinNotice.textContent = `Tu PIN es ${data.pin}. Introduce ese PIN para entrar.`;
        return;
      }
      await update(uRef, { connected:true });
    }

    pinNotice.style.display="block";
    pinNotice.textContent = `Tu PIN es ${pinToUse}. Se ha guardado en este dispositivo.`;

    session.num=num; session.pin=pinToUse; session.role="user"; saveSession();
    afterLogin();
  }
  loginBtn.addEventListener("click", doLogin);
  numInput.addEventListener("keydown", (e)=>{ if(e.key==="Enter") doLogin(); });
  pinInput.addEventListener("keydown", (e)=>{ if(e.key==="Enter") doLogin(); });

  // After login
  function afterLogin(){
    setRoomUI();
    meCode.textContent = session.num;
    loginCard.style.display="none"; chatCard.style.display="block";
    logoutTop.style.display="inline-flex"; logoutBtn.style.display="inline-flex";
    attachMessages();

    if(isAdmin()){
      adminCard.style.display="grid";
      loadUsers();
      loadRooms();
      loadAutoFlag();
    }else{
      adminCard.style.display="none";
    }
  }

  async function doLogout(){
    try{
      if(session.num>0){ await update(roomRef(`users/${session.num}`), { connected:false }); }
    }catch{}
    clearSession();
    loginCard.style.display="flex"; chatCard.style.display="none";
    logoutTop.style.display="none"; logoutBtn.style.display="none";
    pinNotice.style.display="none";
  }
  logoutTop.addEventListener("click", doLogout);
  logoutBtn.addEventListener("click", doLogout);

  // Messages
  let listening=false;
  function attachMessages(){
    if(listening) return; listening=true;
    const msgsRef = roomRef("messages");
    onChildAdded(msgsRef, (snap)=>{
      const m = snap.val();
      renderMsg(m);
    });
  }
  function renderMsg(m){
    if(welcomeBox && welcomeBox.parentNode){ welcomeBox.remove(); }
    const wrap=document.createElement("div");
    wrap.style.display="flex"; wrap.style.justifyContent = (m.from===session.num || (isAdmin() && m.from===0)) ? "flex-end":"flex-start";
    const b=document.createElement("div"); b.className="bubble"+(m.system?" system":(m.from===session.num||m.from===0?" me":""));
    b.textContent=m.text||"";
    const meta=document.createElement("div"); meta.className="meta";
    meta.textContent = (m.privateTo? `#${m.from} ‚Üí #${m.privateTo}`:`#${m.from}`) + " ¬∑ " + (m.ts? new Date(m.ts).toLocaleTimeString([], {hour:"2-digit",minute:"2-digit"}):"");
    b.appendChild(meta);
    wrap.appendChild(b);
    messages.appendChild(wrap);
    messages.scrollTop = messages.scrollHeight;
  }

  async function sendMsg(){
    const raw=(msgInput.value||"").trim(); if(!raw) return;
    let privateTo=null, text=raw;
    const m=raw.match(/^@(\d+)\s+(.+)/);
    if(m){ privateTo=Number(m[1]); text=m[2]; }
    const payload={ from: isAdmin()?0:session.num, text, ts:Date.now(), privateTo };
    await push(roomRef("messages"), payload);
    msgInput.value="";
  }
  sendBtn.addEventListener("click", sendMsg);
  msgInput.addEventListener("keydown",(e)=>{ if(e.key==="Enter"){ e.preventDefault(); sendMsg(); }});

  // Admin
  async function loadUsers(){
    const snap=await get(roomRef("users")); usersList.innerHTML="";
    if(!snap.exists()) return;
    const users=snap.val();
    Object.keys(users).sort((a,b)=>Number(a)-Number(b)).forEach(k=>{
      const u=users[k];
      const row=document.createElement("div"); row.className="userRow";
      const c1=document.createElement("div"); c1.textContent="#"+k; row.appendChild(c1);
      const c2=document.createElement("div"); c2.innerHTML=`PIN: <span class="badge">${u.pin||"-"}</span> ¬∑ <span class="badge">${u.active?"Activo":"Inactivo"}</span>`; row.appendChild(c2);
      const tog=document.createElement("button"); tog.className="btn"; tog.textContent=u.active?"Desactivar":"Activar";
      tog.addEventListener("click", async()=>{ await update(roomRef("users/"+k), { active: !u.active }); loadUsers(); });
      row.appendChild(tog);
      const kick=document.createElement("button"); kick.className="btn ghost"; kick.textContent="Desconectar";
      kick.addEventListener("click", async()=>{ await update(roomRef("users/"+k), { connected:false }); loadUsers(); });
      row.appendChild(kick);
      usersList.appendChild(row);
    });
  }

  async function loadRooms(){
    const s=await get(indexRef); const list=s.exists()?s.val():{ [DEFAULT_ROOM]:true };
    fillRooms(list);
  }
  function fillRooms(obj){
    roomSelect.innerHTML="";
    Object.keys(obj||{}).sort().forEach(k=>{
      const o=document.createElement("option"); o.value=k; o.textContent=k; if(k===session.room) o.selected=true; roomSelect.appendChild(o);
    });
  }
  useRoom.addEventListener("click", async()=>{
    const r=roomSelect.value; if(!r || r===session.room) return;
    session.room=r; saveSession(); setRoomUI();
    messages.innerHTML=""; messages.appendChild(welcomeBox.cloneNode(true));
    listening=false; attachMessages();
    if(isAdmin()){ loadUsers(); loadAutoFlag(); }
  });
  addRoom.addEventListener("click", async()=>{
    const n=(newRoom.value||"").trim(); if(!n) return;
    const s=await get(indexRef); const list=s.exists()?s.val():{}; list[n]=true; await set(indexRef, list);
    fillRooms(list); newRoom.value="";
  });
  renRoom.addEventListener("click", async()=>{
    const n=(newRoom.value||"").trim(); if(!n) return;
    const old=roomSelect.value; if(old===n) return;
    const s=await get(indexRef); const list=s.exists()?s.val():{};
    delete list[old]; list[n]=true; await set(indexRef, list);
    // mover datos
    const oldRef=roomRef("").parent.child(`rooms/${old}`);
  });
  delRoom.addEventListener("click", async()=>{
    const r=roomSelect.value; if(!r) return;
    if(!confirm("Eliminar sala "+r+"?")) return;
    const s=await get(indexRef); const list=s.exists()?s.val():{}; delete list[r]; await set(indexRef, list);
    await set(ref(db, `rooms/${r}`), null);
    if(session.room===r){ session.room=DEFAULT_ROOM; saveSession(); setRoomUI(); listening=false; attachMessages(); }
    fillRooms(list);
  });

  async function loadAutoFlag(){
    const s=await get(roomRef("state")); const v=(s.exists() && s.val().autoMsgs)?true:false;
    autoState.textContent = v?"ON":"OFF";
  }
  autoBtn.addEventListener("click", async()=>{
    const s=await get(roomRef("state")); const v=(s.exists() && s.val().autoMsgs)?true:false;
    await update(roomRef("state"), { autoMsgs: !v });
    loadAutoFlag();
  });

  // Restore session
  loadSession(); setRoomUI(); ensureIndex().then(()=>{
    if(session.num!==null){ afterLogin(); } else { loginCard.style.display="flex"; }
  });
</script>
</body>
</html>
