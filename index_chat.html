<!DOCTYPE html>
<html lang="es">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>X Code Chat ‚Äî Official</title>
  <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
  <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700&display=swap" rel="stylesheet">
  <style>
    :root{
      --bg:#0c0c0c;
      --panel:#141414;
      --text:#fff;
      --muted:#cfcfcf;
      --border:rgba(255,255,255,.16);
      --accent:#ffffff;
      --chip:#1d1d1d;
      --danger:#ff3344;
      --ok:#1ec28b;
      --hint:#999;
      --btn:#fff;
      --btnText:#000;
      --pill:#101010;
      --shadow:0 10px 30px rgba(0,0,0,.35), inset 0 0 0 1px var(--border);
    }
    *{box-sizing:border-box}
    html,body{height:100%}
    body{
      margin:0;background:var(--bg);color:var(--text);
      font-family:Inter, system-ui, -apple-system, Segoe UI, Roboto, Arial, sans-serif;
      -webkit-font-smoothing:antialiased;line-height:1.4;
      display:flex;align-items:center;justify-content:center;
    }
    .wrap{width:min(940px, 92vw);}
    header{
      display:flex;align-items:center;justify-content:space-between;
      gap:14px;margin:14px 0 8px 0;
    }
    .brand{display:flex;align-items:center;gap:12px}
    .logo{
      width:36px;height:36px;border-radius:50%;
      display:grid;place-items:center;background:#1a1a1a;
      border:1px solid var(--border); box-shadow:var(--shadow);
      overflow:hidden;
    }
    .logo img{width:30px;height:30px;object-fit:contain;display:block;filter:none}
    .title{font-size:clamp(18px, 2.7vw, 28px);font-weight:700;letter-spacing:.2px}
    .room{color:var(--muted);font-size:14px;margin-top:-2px}
    .btn{
      appearance:none;border:0;border-radius:12px;padding:10px 16px;
      background:var(--btn);color:var(--btnText);font-weight:600;cursor:pointer;
      box-shadow:var(--shadow);
    }
    .btn.ghost{background:transparent;color:#fff;border:1px solid var(--border)}
    .card{
      width:100%;background:var(--panel);border-radius:16px;padding:18px;
      border:1px solid var(--border); box-shadow:var(--shadow);
    }
    .login{
      display:grid;gap:12px; margin:12px 0 0 0;
    }
    .field{
      position:relative;
      background:var(--pill);border:1px solid var(--border);
      border-radius:14px;padding:14px 16px;display:flex;align-items:center;
    }
    .field input{
      background:transparent;border:0;outline:0;color:var(--text);
      font-size:16px;flex:1;
    }
    .eye{
      position:absolute;right:12px;top:50%;transform:translateY(-50%);
      width:24px;height:24px;border-radius:50%;display:grid;place-items:center;
      cursor:pointer;border:1px solid var(--border);background:#1b1b1b;
    }
    .hint{color:var(--hint);font-size:13px;margin-top:4px}
    .chat{margin-top:14px}
    .stream{height:min(55vh, 520px);overflow:auto;padding:12px;border-radius:14px;
      border:1px dashed var(--border);background:#0f0f0f}
    .empty{
      color:#e6e6e6;background:#0f0f0f;border:1px dashed var(--border);
      padding:14px 16px;border-radius:12px;display:none;
    }
    .composer{display:flex;gap:10px;align-items:center;margin-top:12px}
    .composer .field{flex:1}
    .system{font-size:12px;color:var(--hint);text-align:center;margin-top:6px}
    .bubble{max-width:78%;padding:10px 14px;border-radius:14px;display:inline-block;margin:5px 0}
    .me{background:#111;border:1px solid var(--border)}
    .them{background:#0d0d0d;border:1px solid var(--border)}
    .meta{font-size:12px;color:var(--hint);margin-top:4px}
    .toast{
      position:fixed;left:50%;bottom:24px;transform:translateX(-50%);
      background:#161616;border:1px solid var(--border);color:#fff;
      padding:12px 16px;border-radius:12px;box-shadow:var(--shadow);display:none;
      max-width:min(92vw, 520px);
    }
    /* Admin */
    .adminPanel{display:none;gap:12px;margin-top:12px}
    .grid{display:grid;grid-template-columns:1fr auto auto;gap:8px;align-items:center}
    .pill{background:var(--chip);border:1px solid var(--border);padding:8px 10px;border-radius:999px;font-size:13px}
    .danger{background:#2a0f12;color:#fff;border-color:#5c2630}
    .ok{background:#0e2a21;color:#fff;border-color:#214e3e}
    /* Modal for admin login (popup style) */
    .modal-backdrop{position:fixed;inset:0;background:rgba(0,0,0,.6);display:none;align-items:center;justify-content:center;padding:20px;z-index:20}
    .modal{background:#121212;border:1px solid var(--border);border-radius:16px;padding:18px;width:min(420px, 92vw);box-shadow:var(--shadow)}
    .modal h3{margin:0 0 8px 0}
    .modal .actions{display:flex;gap:8px;justify-content:flex-end;margin-top:10px}
    @media (max-width:520px){
      .stream{height:52vh}
    }
  </style>
</head>
<body>
  <div class="wrap">
    <header>
      <div class="brand">
        <div class="logo"><img id="logo" alt="X Code Logo"></div>
        <div>
          <div class="title">X Code Chat ‚Äî Official</div>
          <div class="room">Sala: <span id="roomName">Sala de Prueba</span></div>
        </div>
      </div>
      <button id="btnSalir" class="btn ghost" style="display:none">Salir</button>
    </header>

    <!-- LOGIN CARD -->
    <div id="loginCard" class="card">
      <div class="hint">Acceso con <b>n√∫mero</b> y <b>PIN</b>. En tu primer acceso, el PIN se genera autom√°ticamente. <span style="opacity:.6">Usuario 0 (organizador): solo contrase√±a.</span></div>
      <div class="login">
        <div class="field"><input id="inpNumero" type="number" placeholder="Tu n√∫mero (ej. 70)" min="0" inputmode="numeric"></div>
        <div class="field">
          <input id="inpPin" type="password" placeholder="Tu PIN (si ya tienes)" inputmode="numeric" pattern="[0-9]*">
          <div id="eye" class="eye" title="Mostrar/Ocultar PIN">üëÅÔ∏è</div>
        </div>
        <div style="display:flex;gap:8px;align-items:center">
          <button id="btnEntrar" class="btn">Entrar</button>
          <div id="loginMsg" class="hint"></div>
        </div>
      </div>
    </div>

    <!-- CHAT CARD -->
    <div id="chatCard" class="card" style="display:none">
      <div class="chat">
        <div id="emptyMsg" class="empty">üëã Bienvenido. A√∫n no hay mensajes. Este aviso desaparecer√° en cuanto se publique alguno.</div>
        <div id="stream" class="stream"></div>
        <div class="composer">
          <div class="field"><input id="inpMsg" placeholder="Escribe un mensaje‚Ä¶ ¬∑ Privado: @n√∫mero" maxlength="400"></div>
          <button id="btnSend" class="btn">Enviar</button>
        </div>
        <div class="system">P√∫blico por defecto ¬∑ Privado con <b>@n√∫mero</b> (ej. <b>@120 hola</b>)</div>
      </div>

      <!-- ADMIN PANEL -->
      <div id="adminPanel" class="adminPanel card">
        <div style="display:flex;gap:8px;flex-wrap:wrap;align-items:center">
          <button id="btnGlobal" class="btn">Mensaje global</button>
          <button id="btnAuto" class="btn ghost">Mensajes auto: <span id="autoState">OFF</span></button>
        </div>
        <div style="margin-top:8px;font-weight:600">Usuarios (PIN visible solo para admin)</div>
        <div id="usersList" class="grid" style="margin-top:6px"></div>
      </div>
    </div>
  </div>

  <!-- Toast -->
  <div id="toast" class="toast"></div>

  <!-- Admin modal (popup) -->
  <div id="adminBack" class="modal-backdrop" aria-hidden="true">
    <div class="modal" role="dialog" aria-modal="true">
      <h3>Acceso organizador</h3>
      <div class="field"><input id="inpAdminPass" type="password" placeholder="Contrase√±a" autocomplete="off"></div>
      <div class="actions">
        <button id="btnAdminCancel" class="btn ghost">Cancelar</button>
        <button id="btnAdminOk" class="btn">Entrar</button>
      </div>
      <div class="hint">El organizador es el <b>n√∫mero 0</b>. No necesita PIN, solo contrase√±a.</div>
    </div>
  </div>

  <script type="module">
    // ---- Firebase (modular v10) ----
    import { initializeApp } from 'https://www.gstatic.com/firebasejs/10.12.5/firebase-app.js';
    import { getDatabase, ref, onValue, set, get, update, serverTimestamp } from 'https://www.gstatic.com/firebasejs/10.12.5/firebase-database.js';
    // Config del usuario
    const firebaseConfig = {
      apiKey: "AIzaSyD66wsrvZmQmzmp0htKmrxCbFwOmeijqiQ",
      authDomain: "x-code-chat.firebaseapp.com",
      databaseURL: "https://x-code-chat-default-rtdb.europe-west1.firebasedatabase.app",
      projectId: "x-code-chat",
      storageBucket: "x-code-chat.firebasestorage.app",
      messagingSenderId: "819845037951",
      appId: "1:819845037951:web:f0fe8971356afb2f66a44a"
    };
    const app = initializeApp(firebaseConfig);
    const db = getDatabase(app);

    // ---- Elements ----
    const loginCard = document.getElementById('loginCard');
    const chatCard  = document.getElementById('chatCard');
    const btnEntrar = document.getElementById('btnEntrar');
    const inpNumero = document.getElementById('inpNumero');
    const inpPin    = document.getElementById('inpPin');
    const loginMsg  = document.getElementById('loginMsg');
    const btnSalir  = document.getElementById('btnSalir');
    const stream    = document.getElementById('stream');
    const emptyMsg  = document.getElementById('emptyMsg');
    const inpMsg    = document.getElementById('inpMsg');
    const btnSend   = document.getElementById('btnSend');
    const toast     = document.getElementById('toast');
    const eye       = document.getElementById('eye');
    // Admin
    const adminPanel= document.getElementById('adminPanel');
    const usersList = document.getElementById('usersList');
    const adminBack = document.getElementById('adminBack');
    const inpAdminPass=document.getElementById('inpAdminPass');
    const btnAdminOk = document.getElementById('btnAdminOk');
    const btnAdminCancel=document.getElementById('btnAdminCancel');
    const btnGlobal = document.getElementById('btnGlobal');
    const btnAuto   = document.getElementById('btnAuto');
    const autoState = document.getElementById('autoState');

    // ---- State ----
    const ROOM = localStorage.getItem('xcode_room') || 'Sala de Prueba';
    document.getElementById('roomName').textContent = ROOM;

    let currentUser = null; // {num, pin, isAdmin}
    let unsubMessages = null;

    const pinKey = (num)=>`xcode_pin_${ROOM}_${num}`;
    const meKey  = `xcode_me_${ROOM}`;
    const adminKey = `xcode_admin_${ROOM}`; // persist admin session (no re-login)

    // ---- Helpers ----
    const showToast = (msg, ms=2200)=>{
      toast.textContent = msg; toast.style.display='block';
      clearTimeout(showToast._t); showToast._t = setTimeout(()=>toast.style.display='none', ms);
    };
    const scrollToBottom = ()=>{ stream.scrollTop = stream.scrollHeight; };

    // Toggle PIN visibility
    eye.addEventListener('click', ()=>{
      inpPin.type = (inpPin.type === 'password') ? 'text' : 'password';
    });

    // Load persisted session
    (function boot(){
      const saved = JSON.parse(localStorage.getItem(meKey) || 'null');
      if(saved && typeof saved.num !== 'undefined'){
        // If admin persisted, restore without asking pass again
        if(saved.isAdmin && localStorage.getItem(adminKey)==='1'){
          currentUser = saved;
          enterChatUI();
          bindMessages();
          bindAdmin();
          return;
        }
        // Normal user ‚Äî restore if we still have PIN
        const p = localStorage.getItem(pinKey(saved.num));
        if(p){
          inpNumero.value = saved.num;
          inpPin.value = p;
        }
      }
    })();

    // ---- Login ----
    btnEntrar.addEventListener('click', async ()=>{
      const num = String(inpNumero.value || '').trim();
      const pin = String(inpPin.value || '').trim();

      if(num === ''){ showToast('Escribe tu n√∫mero.'); return; }
      if(!/^\d+$/.test(num)){ showToast('N√∫mero inv√°lido.'); return; }

      if(num === '0'){ // Organizador
        // If already persisted admin session, let in directly
        if(localStorage.getItem(adminKey)==='1'){
          currentUser = {num:'0', pin:'', isAdmin:true};
          localStorage.setItem(meKey, JSON.stringify(currentUser));
          enterChatUI(); bindMessages(); bindAdmin(); return;
        }
        // Ask password in popup
        adminBack.style.display='flex';
        inpAdminPass.focus();
        btnAdminOk.onclick = ()=>{
          if(inpAdminPass.value === '131215'){
            adminBack.style.display='none';
            localStorage.setItem(adminKey,'1'); // persist until "Salir"
            currentUser = {num:'0', pin:'', isAdmin:true};
            localStorage.setItem(meKey, JSON.stringify(currentUser));
            enterChatUI(); bindMessages(); bindAdmin();
          }else{
            showToast('Contrase√±a incorrecta.');
          }
        };
        btnAdminCancel.onclick = ()=>{ adminBack.style.display='none'; };
        return;
      }

      // Normal user
      const userRef = ref(db, `rooms/${ROOM}/users/${num}`);
      const snap = await get(userRef);
      let finalPin = pin;
      if(!snap.exists()){ // first time ‚Üí generate
        finalPin = ('' + Math.floor(1000 + Math.random()*9000));
        await set(userRef, {pin: finalPin, active: true, ts: serverTimestamp()});
        showToast(`Tu PIN es ${finalPin}. Se ha guardado en este dispositivo. Accediendo‚Ä¶`, 2600);
      }else{
        const data = snap.val();
        if(!finalPin){ finalPin = data.pin; } // auto-complete if empty
        if(finalPin !== data.pin){ showToast('PIN incorrecto.'); return; }
        await update(userRef, {active:true, ts: serverTimestamp()});
      }

      // Persist locally & enter
      localStorage.setItem(pinKey(num), finalPin);
      currentUser = {num, pin: finalPin, isAdmin:false};
      localStorage.setItem(meKey, JSON.stringify(currentUser));
      enterChatUI(); bindMessages(); // no admin bind
    });

    function enterChatUI(){
      loginCard.style.display='none';
      chatCard.style.display='block';
      btnSalir.style.display='inline-block';
      inpMsg.focus();
    }

    // ---- Messages binding ----
    function bindMessages(){
      const msgsRef = ref(db, `rooms/${ROOM}/messages`);
      if(unsubMessages) unsubMessages(); // not needed with onValue; kept for symmetry
      onValue(msgsRef, (snap)=>{
        const list = snap.val() || {};
        const arr = Object.entries(list).sort((a,b)=> (a[1].ts||0) - (b[1].ts||0));
        stream.innerHTML = '';
        if(arr.length===0){ emptyMsg.style.display='block'; }
        else emptyMsg.style.display='none';
        arr.forEach(([id, m])=>{
          const div = document.createElement('div');
          const me = (String(m.from) === String(currentUser?.num));
          const pri = m.to ? ` ¬∑ <b>Privado</b> ‚Üí #${m.to}` : '';
          div.className='bubble ' + (me?'me':'them');
          div.innerHTML = `${m.text||''}<div class="meta">#${m.from}${pri} ¬∑ ${m.time||''}</div>`;
          stream.appendChild(div);
        });
        scrollToBottom();
      });
    }

    // ---- Send message ----
    btnSend.addEventListener('click', async ()=>{
      const txt = String(inpMsg.value||'').trim();
      if(!txt) return;
      // Private?
      let to = null, body = txt;
      const m = txt.match(/^@(\d+)\s+(.+)/);
      if(m){ to = m[1]; body = m[2]; }
      const id = Date.now()+ '_' + Math.random().toString(36).slice(2,7);
      const time = new Date().toLocaleTimeString('es-ES',{hour:'2-digit',minute:'2-digit'});
      await set(ref(db, `rooms/${ROOM}/messages/${id}`), {
        from: currentUser.num, to, text: body, time, ts: Date.now()
      });
      inpMsg.value='';
    });

    // ---- Admin features ----
    function bindAdmin(){
      if(!currentUser?.isAdmin){ adminPanel.style.display='none'; return; }
      adminPanel.style.display='block';
      // List users
      onValue(ref(db, `rooms/${ROOM}/users`), (snap)=>{
        usersList.innerHTML='';
        const users = snap.val() || {};
        Object.keys(users).sort((a,b)=> Number(a)-Number(b)).forEach(num=>{
          if(num==='0') return;
          const u = users[num];
          const row = document.createElement('div');
          row.className='grid';
          row.innerHTML = `
            <div class="pill">#${num} ¬∑ PIN: <b>${u.pin||'‚Äî'}</b> ¬∑ ${u.active?'Activo':'Inactivo'}</div>
            <button class="btn ghost" data-num="${num}" data-act="${u.active?'des':'act'}">${u.active?'Desactivar':'Activar'}</button>
            <button class="btn danger" data-kill="${num}">Desconectar</button>
          `;
          usersList.appendChild(row);
        });
      });
      // Toggle active
      usersList.addEventListener('click', async (e)=>{
        const t = e.target;
        if(t.dataset?.num){
          const n=t.dataset.num, action=t.dataset.act;
          await update(ref(db, `rooms/${ROOM}/users/${n}`), {active: action==='act'});
        }
        if(t.dataset?.kill){
          const n=t.dataset.kill;
          await update(ref(db, `rooms/${ROOM}/users/${n}`), {active:false});
        }
      });
      // Auto messages toggle (flag in DB)
      onValue(ref(db, `rooms/${ROOM}/auto`),(s)=>{
        const on = !!s.val(); autoState.textContent = on?'ON':'OFF';
      });
      btnAuto.onclick = async ()=>{
        const s = await get(ref(db, `rooms/${ROOM}/auto`));
        await set(ref(db, `rooms/${ROOM}/auto`), !s.val());
      };
      // Global message
      btnGlobal.onclick = async ()=>{
        const txt = prompt('Mensaje global'); if(!txt) return;
        const id = Date.now()+ '_' + Math.random().toString(36).slice(2,7);
        const time = new Date().toLocaleTimeString('es-ES',{hour:'2-digit',minute:'2-digit'});
        await set(ref(db, `rooms/${ROOM}/messages/${id}`), { from:'ORG', text: txt, time, ts: Date.now() });
      };
    }

    // ---- Salir ----
    btnSalir.addEventListener('click', ()=>{
      localStorage.removeItem(meKey);
      if(currentUser?.isAdmin) localStorage.removeItem(adminKey);
      location.reload();
    });

    // Allow Enter to submit
    inpNumero.addEventListener('keydown', e=>{ if(e.key==='Enter') btnEntrar.click(); });
    inpPin.addEventListener('keydown', e=>{ if(e.key==='Enter') btnEntrar.click(); });
    inpMsg.addEventListener('keydown', e=>{ if(e.key==='Enter') btnSend.click(); });

    // Fallback logo (keeps your previous behavior if the src was failing)
    const logo = document.getElementById('logo');
    // Set your logo URL here if needed:
    // logo.src = 'https://.../x-logo.png';
  </script>
</body>
</html>
