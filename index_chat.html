<!DOCTYPE html>
<html lang="es">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>X Code Chat ‚Äî Official</title>
  <link rel="preconnect" href="https://fonts.googleapis.com">
  <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
  <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;600;700&display=swap" rel="stylesheet">
  <style>
    :root{
      --bg:#000;
      --panel:#0b0b0b;
      --text:#fff;
      --muted:#bdbdbd;
      --accent:#fff;
      --border:rgba(255,255,255,0.2);
      --chip:#111;
    }
    *{box-sizing:border-box}
    html,body{height:100%}
    body{
      margin:0;
      background:var(--bg);
      color:var(--text);
      font-family:Inter, system-ui, -apple-system, Segoe UI, Roboto, Arial, sans-serif;
    }
    .wrap{
      max-width:960px;
      margin:0 auto;
      padding:12px 14px 16px;
      min-height:100%;
      display:flex; flex-direction:column;
      gap:12px;
    }
    header{
      border:1px solid var(--border);
      border-radius:18px;
      padding:14px 16px;
      background:var(--panel);
      display:flex; align-items:center; justify-content:space-between; gap:10px;
    }
    .brand{display:flex; align-items:center; gap:12px;}
    .logo{
      width:28px; height:28px; border-radius:50%;
      display:grid; place-items:center; border:1px solid var(--border);
      background:#000;
    }
    .logo svg{width:20px; height:20px; display:block}
    .title{font-weight:700; font-size:22px; line-height:1}
    .subtitle{font-size:14px; color:var(--muted)}
    .btn{
      background:#fff; color:#000; border:none; border-radius:12px;
      padding:10px 14px; font-weight:600; cursor:pointer
    }
    .btn:disabled{opacity:.6; cursor:not-allowed}
    .panel{
      border:1px solid var(--border);
      border-radius:18px;
      background:var(--panel);
      padding:14px;
    }
    .login p{margin:0 0 10px; color:var(--muted)}
    .field{position:relative; margin-bottom:10px}
    input[type="number"],input[type="password"],input[type="text"]{
      width:100%; background:#0f0f0f; color:var(--text);
      border:1px solid var(--border); border-radius:14px;
      padding:14px 46px 14px 16px; font-size:18px; outline:none;
    }
    .eye{
      position:absolute; right:6px; top:50%; transform:translateY(-50%);
      width:36px; height:36px; border-radius:10px; display:grid; place-items:center;
      cursor:pointer; border:1px solid var(--border); background:#0e0e0e;
    }
    .chat{
      flex:1; min-height:0; display:flex; flex-direction:column;
      gap:10px;
    }
    #messages{
      flex:1; min-height:240px; max-height:calc(100vh - 320px);
      overflow:auto; padding:8px 4px;
      display:flex; flex-direction:column; gap:8px;
      scroll-behavior:smooth;
    }
    .msg{
      max-width:85%; padding:10px 12px; border:1px solid var(--border);
      border-radius:14px; background:var(--chip); font-size:16px;
      line-height:1.25;
    }
    .mine{margin-left:auto; border-color:#fff; box-shadow:0 0 0 1px #fff inset}
    .meta{color:var(--muted); font-size:12px; margin-top:4px}
    .composer{
      display:flex; gap:10px; align-items:center;
      border:1px solid var(--border); border-radius:18px; padding:10px;
      background:var(--panel);
      position:sticky; bottom:0;
    }
    .composer input{flex:1; padding:12px 14px; border-radius:12px}
    .helper{color:var(--muted); font-size:12px; margin-top:6px; text-align:center}
    .toast{position:fixed; left:50%; transform:translateX(-50%);
      bottom:16px; background:#111; color:#fff; border:1px solid var(--border);
      padding:10px 14px; border-radius:12px; z-index:99; display:none;}
    .pill{display:inline-block; padding:4px 8px; border:1px solid var(--border); border-radius:999px; font-size:12px; color:var(--muted)}
    @media (max-width:480px){
      .title{font-size:20px}
      #messages{max-height:calc(100vh - 300px);}
    }
  </style>
</head>
<body>
  <div class="wrap">
    <header>
      <div class="brand">
        <div class="logo" aria-hidden="true">
          <!-- Gold X inline SVG -->
          <svg viewBox="0 0 24 24" fill="none">
            <circle cx="12" cy="12" r="10" stroke="#D0A500" stroke-width="2"/>
            <path d="M8 8l8 8M16 8l-8 8" stroke="#D0A500" stroke-width="2" stroke-linecap="round"/>
          </svg>
        </div>
        <div>
          <div class="title">X Code Chat ‚Äî Official</div>
          <div class="subtitle">Sala: <span id="roomName">Sala de Prueba</span></div>
        </div>
      </div>
      <button id="logoutBtn" class="btn" style="display:none">Salir</button>
    </header>

    <!-- Login -->
    <section id="loginBox" class="panel login">
      <p><strong>Acceso con n√∫mero y PIN.</strong> En tu primer acceso, el PIN se genera autom√°ticamente.</p>
      <div class="field">
        <input id="numberInput" type="number" inputmode="numeric" placeholder="Tu n√∫mero (ej. 70)" />
      </div>
      <div class="field">
        <input id="pinInput" type="password" inputmode="numeric" placeholder="Tu PIN (si ya tienes) ¬∑ Admin: contrase√±a" />
        <button class="eye" id="togglePin" aria-label="Ver PIN">üëÅÔ∏è</button>
      </div>
      <button id="enterBtn" class="btn">Entrar</button>
    </section>

    <!-- Chat -->
    <section id="chatBox" class="panel chat" style="display:none">
      <div id="messages"></div>
      <div class="composer">
        <input id="msgInput" type="text" placeholder="Escribe un mensaje‚Ä¶ ¬∑ Privado: @n√∫mero" autocomplete="off" />
        <button id="sendBtn" class="btn">Enviar</button>
      </div>
      <div class="helper">P√∫blico por defecto ¬∑ Privado con <b>@n√∫mero</b> (ej. @120 hola)</div>
    </section>

    <div class="toast" id="toast"></div>
  </div>

  <script type="module">
    // Firebase v9 modular from CDN
    import { initializeApp } from "https://www.gstatic.com/firebasejs/10.13.1/firebase-app.js";
    import { getDatabase, ref, get, set, push, onChildAdded, onValue, update } from "https://www.gstatic.com/firebasejs/10.13.1/firebase-database.js";

    // ---------- Config (mantengo la que me diste) ----------
    const firebaseConfig = {
      apiKey: "AIzaSyD66wsrvZmQmzmp0htKmrxCbFwOmeijqiQ",
      authDomain: "x-code-chat.firebaseapp.com",
      databaseURL: "https://x-code-chat-default-rtdb.europe-west1.firebasedatabase.app",
      projectId: "x-code-chat",
      storageBucket: "x-code-chat.firebasestorage.app",
      messagingSenderId: "819845037951",
      appId: "1:819845037951:web:f0fe8971356afb2f66a44a"
    };
    const ADMIN_PASS = "131215";
    const ROOM = "Sala de Prueba";

    const app = initializeApp(firebaseConfig);
    const db = getDatabase(app);

    // ---------- Helpers UI ----------
    const $ = sel => document.querySelector(sel);
    const toast = (msg, ms=3000) => {
      const t = $("#toast"); t.textContent = msg; t.style.display="block";
      clearTimeout(window.__t); window.__t=setTimeout(()=>t.style.display="none", ms);
    };
    const scrollToBottom = () => {
      const el = $("#messages"); el.scrollTop = el.scrollHeight;
    };

    // ---------- Elements ----------
    const loginBox = $("#loginBox");
    const chatBox = $("#chatBox");
    const roomName = $("#roomName");
    const numberInput = $("#numberInput");
    const pinInput = $("#pinInput");
    const enterBtn = $("#enterBtn");
    const togglePin = $("#togglePin");
    const logoutBtn = $("#logoutBtn");
    const messagesEl = $("#messages");
    const msgInput = $("#msgInput");
    const sendBtn = $("#sendBtn");

    roomName.textContent = ROOM;

    togglePin.addEventListener("click", () => {
      pinInput.type = pinInput.type === "password" ? "text" : "password";
    });

    // ---------- Session ----------
    function saveSession(s){
      localStorage.setItem("xcode_session", JSON.stringify(s));
    }
    function loadSession(){
      try { return JSON.parse(localStorage.getItem("xcode_session")||"null"); } catch(e){ return null; }
    }
    function clearSession(){
      localStorage.removeItem("xcode_session");
    }

    // ---------- Auth flow ----------
    async function ensureUser(number, pinMaybe){
      const userRef = ref(db, `rooms/${ROOM}/users/${number}`);
      const snap = await get(userRef);
      if(number === 0){
        // admin: password only
        if(pinMaybe !== ADMIN_PASS) throw new Error("Contrase√±a admin incorrecta.");
        await set(userRef, { active: true, admin: true, updated: Date.now() });
        return { number, pin: null, admin: true };
      }
      if(snap.exists()){
        const data = snap.val();
        if(String(pinMaybe) !== String(data.pin)) throw new Error("PIN incorrecto o faltante.");
        await update(userRef, { active: true, updated: Date.now() });
        return { number, pin: data.pin, admin:false };
      }else{
        // first time: generate pin
        const pin = Math.floor(1000 + Math.random()*9000);
        await set(userRef, { pin, active: true, admin:false, created: Date.now() });
        toast(`Tu PIN es ${pin}. Se ha guardado en este dispositivo. Entrando‚Ä¶`, 2500);
        return { number, pin, admin:false, first:true };
      }
    }

    async function login(){
      const number = Number(numberInput.value.trim());
      const pin = pinInput.value.trim();
      if(!number && number !== 0) { toast("Introduce tu n√∫mero", 2000); return; }
      enterBtn.disabled = true;

      try{
        const session = await ensureUser(number, pin);
        saveSession({ room: ROOM, number: session.number, pin: session.pin, admin: !!session.admin });
        startChat(session.number, session.pin, !!session.admin);
        numberInput.value=""; pinInput.value="";
        loginBox.style.display="none"; chatBox.style.display="";
        logoutBtn.style.display="";
      }catch(e){
        toast(e.message || "No se pudo iniciar sesi√≥n");
      }finally{
        enterBtn.disabled = false;
      }
    }

    enterBtn.addEventListener("click", login);
    pinInput.addEventListener("keydown", (e)=>{ if(e.key==="Enter") login(); });
    numberInput.addEventListener("keydown", (e)=>{ if(e.key==="Enter") login(); });

    logoutBtn.addEventListener("click", async ()=>{
      const s = loadSession();
      if(s){
        await update(ref(db, `rooms/${ROOM}/users/${s.number}`), { active:false, updated: Date.now() });
      }
      clearSession();
      chatBox.style.display="none";
      logoutBtn.style.display="none";
      loginBox.style.display="";
      messagesEl.innerHTML="";
      msgInput.value="";
    });

    // ---------- Chat ----------
    let myNumber = null;
    function renderMessage(key, obj){
      const isPrivate = !!obj.to;
      // show only if public, or I'm sender, or I'm target
      if(isPrivate && !(obj.from===myNumber || obj.to===myNumber)) return;

      const li = document.createElement("div");
      li.className = "msg" + (obj.from===myNumber ? " mine": "");
      const time = new Date(obj.ts||Date.now());
      const hh = String(time.getHours()).padStart(2,"0");
      const mm = String(time.getMinutes()).padStart(2,"0");
      let meta = `#${obj.from} ¬∑ ${hh}:${mm}`;
      if(isPrivate) meta += ` ¬∑ Privado ${obj.from===myNumber ? `‚Üí #${obj.to}` : `de #${obj.from}`}`;
      li.innerHTML = `${obj.text.replace(/</g,"&lt;")}
        <div class="meta">${meta}</div>`;
      messagesEl.appendChild(li);
      scrollToBottom();
    }

    function startChat(number, pin, admin){
      myNumber = number;
      // welcome if empty
      const roomRef = ref(db, `rooms/${ROOM}`);
      onValue(ref(db, `rooms/${ROOM}/messages`), (snap)=>{
        if(!snap.exists()){
          messagesEl.innerHTML = `<div class="msg"><b>üëã Bienvenido.</b> A√∫n no hay mensajes. Este aviso desaparecer√° en cuanto se publique alguno.</div>`;
        }else{
          messagesEl.innerHTML="";
          snap.forEach(child=> renderMessage(child.key, child.val()));
        }
        scrollToBottom();
      });
      onChildAdded(ref(db, `rooms/${ROOM}/messages`), (snap)=>{
        renderMessage(snap.key, snap.val());
      });

      async function send(){
        const text = msgInput.value.trim();
        if(!text) return;
        let payload = { from: number, text, ts: Date.now() };
        const m = text.match(/^@(\d+)\s+(.*)$/);
        if(m){ payload.to = Number(m[1]); payload.text = m[2]; }
        await push(ref(db, `rooms/${ROOM}/messages`), payload);
        msgInput.value="";
      }
      sendBtn.onclick = send;
      msgInput.onkeydown = (e)=>{ if(e.key==="Enter"){ e.preventDefault(); send(); } };
    }

    // ---------- Auto-resume ----------
    (async function auto(){
      try{
        const s = loadSession();
        if(!s || s.room!==ROOM) return;
        // validate
        if(s.number===0){
          // admin stays if password known previously (not stored). Require manual re-login for admin for seguridad
          return;
        }
        const snap = await get(ref(db, `rooms/${ROOM}/users/${s.number}`));
        if(snap.exists() && String(snap.val().pin)===String(s.pin)){
          startChat(s.number, s.pin, false);
          loginBox.style.display="none"; chatBox.style.display=""; logoutBtn.style.display="";
        }else{
          clearSession();
        }
      }catch(_){}
    })();
  </script>
</body>
</html>
