<!DOCTYPE html>
<html lang="es">
<head>
<meta charset="utf-8"/>
<meta name="viewport" content="width=device-width, initial-scale=1"/>
<title>X Code Chat ‚Äî Official</title>
<link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;600;700&display=swap" rel="stylesheet">
<style>
:root{
  --bg:#000; --fg:#fff; --muted:#cfcfcf; --line:#2a2a2a; --gold:#D0A500;
}
*{box-sizing:border-box}
html,body{height:100%}
body{margin:0;background:var(--bg);color:var(--fg);font-family:Inter,system-ui,Roboto,Arial,sans-serif}
.wrap{max-width:920px;margin:0 auto;padding:12px;display:flex;flex-direction:column;gap:12px;min-height:100svh}
.card{background:#0b0b0b;border:1px solid var(--line);border-radius:16px;padding:14px}
.header{display:flex;align-items:center;justify-content:space-between;gap:10px}
.brand{display:flex;align-items:center;gap:10px}
.logo{width:28px;height:28px;border-radius:50%;display:grid;place-items:center;background:#111;border:1px solid var(--line);overflow:hidden}
.logo img{width:20px;height:20px;display:block}
.ttl{font-weight:700;font-size:20px}
.sub{font-size:13px;color:var(--muted)}
.btn{appearance:none;border:1px solid #fff;background:#fff;color:#000;border-radius:12px;padding:10px 14px;font-weight:600;cursor:pointer}
.btn.ghost{background:transparent;color:#fff}
.btn.sm{padding:8px 10px;font-size:13px;border-radius:10px}
.field{display:flex;align-items:center;gap:8px;border:1px solid var(--line);border-radius:12px;padding:10px;background:#0a0a0a}
.field input{flex:1;background:transparent;border:none;outline:none;color:var(--fg);font-size:16px}
.eye{cursor:pointer;user-select:none}
.login{max-width:700px;margin:6svh auto 0;display:flex;flex-direction:column;gap:10px}
.hint{color:var(--muted);font-size:13px}
.backdrop{position:fixed;inset:0;background:rgba(0,0,0,.7);display:none;align-items:center;justify-content:center;z-index:1000;padding:16px}
.backdrop.show{display:flex!important}
.modal{background:#101010;border:1px solid var(--line);padding:20px 22px;border-radius:14px;width:min(420px,92vw);text-align:center;box-shadow:0 10px 28px rgba(0,0,0,.35)}
.modal h3{margin:0 0 8px 0;color:var(--gold)}
.modal p{margin:0 0 12px 0;color:#ddd}
.modal .actions{display:flex;gap:8px;justify-content:center}
.toast{position:fixed;left:50%;transform:translateX(-50%);bottom:16px;background:#111;border:1px solid var(--line);color:#fff;padding:10px 14px;border-radius:12px;display:none;z-index:80}
.toast.show{display:block}
</style>
</head>
<body>
<div class="wrap">
  <div class="card header">
    <div class="brand">
      <span class="logo" aria-hidden="true">
        <img src="data:image/svg+xml;base64,PHN2ZyB3aWR0aD0iMjQiIGhlaWdodD0iMjQiIHZpZXdCb3g9IjAgMCAyNCAyNCIgZmlsbD0ibm9uZSIgeG1sbnM9Imh0dHA6Ly93d3cudzMub3JnLzIwMDAvc3ZnIj48Y2lyY2xlIGN4PSIxMiIgY3k9IjEyIiByPSIxMCIgc3Ryb2tlPSIjRDBBQTUwMCIgc3Ryb2tlLXdpZHRoPSIyIi8+PHBhdGggZD0iTTggOEwxNiAxNkwxNiA4TDggMTYiIHN0cm9rZT0iI0QwQUE1MDAiIHN0cm9rZS13aWR0aD0iMiIgc3Ryb2tlLWxpbmVjYXA9InJvdW5kIi8+PC9zdmc+" alt="logo"/>
      </span>
      <div><div class="ttl">X Code Chat ‚Äî Official</div><div class="sub">Sala: <span id="roomHdr">Sala de Prueba</span></div></div>
    </div>
  </div>

  <div id="loginCard" class="card login">
    <div class="hint">Acceso con <b>n√∫mero</b> y <b>PIN</b>. Si tu entrada est√° en la lista oficial, la primera vez se genera tu PIN y se muestra.</div>
    <div class="field"><input id="numInput" type="number" placeholder="Tu n√∫mero"></div>
    <div class="field"><input id="pinInput" type="password" placeholder="Tu PIN"><span id="togglePin" class="eye">üëÅÔ∏è</span></div>
    <div><button id="loginBtn" class="btn">Entrar</button></div>
  </div>
</div>

<div id="toast" class="toast"></div>

<div id="pinBack" class="backdrop" aria-hidden="true">
  <div class="modal">
    <h3>üîê Tu PIN</h3>
    <p id="pinText" style="font-size:1.4em;font-weight:800;color:#00ffbb">0000</p>
    <small style="opacity:.8">Se ha copiado al portapapeles</small>
    <div class="actions"><button id="pinOk" class="btn">Entendido</button></div>
  </div>
</div>

<script type="module">
import { initializeApp } from "https://www.gstatic.com/firebasejs/10.13.1/firebase-app.js";
import { getDatabase, ref, get, set, update } from "https://www.gstatic.com/firebasejs/10.13.1/firebase-database.js";

const firebaseConfig = {
  apiKey: "AIzaSyD66wsrvZmQmzmp0htKmrxCbFwOmeijqiQ",
  authDomain: "x-code-chat.firebaseapp.com",
  databaseURL: "https://x-code-chat-default-rtdb.europe-west1.firebasedatabase.app",
  projectId: "x-code-chat",
  storageBucket: "x-code-chat.firebasestorage.app",
  messagingSenderId: "819845037951",
  appId: "1:819845037951:web:f0fe8971356afb2f66a44a"
};

const app = initializeApp(firebaseConfig);
const db = getDatabase(app);
const $ = q => document.querySelector(q);
const toastEl = $("#toast");
const toast = (t,ms=2500)=>{toastEl.textContent=t;toastEl.classList.add("show");clearTimeout(window._t);window._t=setTimeout(()=>toastEl.classList.remove("show"),ms);};

function showGeneratedPin(pin) {
  const modal = document.getElementById("pinBack");
  const textEl = document.getElementById("pinText");
  const okBtn = document.getElementById("pinOk");
  if (!modal || !textEl || !okBtn) {
    console.error("‚ùå Modal PIN no encontrado");
    toast("Error al mostrar el PIN. Recarga la p√°gina.");
    return;
  }
  textEl.textContent = pin;
  modal.style.display = "flex";
  modal.classList.add("show");
  modal.setAttribute("aria-hidden","false");
  navigator.clipboard.writeText(pin).catch(()=>{});
  okBtn.onclick = () => {
    modal.classList.remove("show");
    modal.style.display = "none";
    modal.setAttribute("aria-hidden","true");
    toast("Introduce tu PIN y pulsa Entrar");
  };
}

async function isEntryAllowed(n){
  const paths=["entradas","tickets"];
  for(const base of paths){
    const s=await get(ref(db,`${base}/${n}`));
    if(s.exists()){
      const d=s.val()||{};
      const estado=(d.estado?String(d.estado).toLowerCase():null);
      if(estado==="activa"||estado==="activo"||d.active===true||d.active==="true") return true;
    }
  }
  return false;
}

const numInput=$("#numInput"), pinInput=$("#pinInput"), loginBtn=$("#loginBtn"), togglePin=$("#togglePin");
togglePin.onclick=()=>pinInput.type=pinInput.type==="password"?"text":"password";

async function doLogin(){
  const n=Number(numInput.value||0);
  const p=(pinInput.value||"").trim();
  if(!n){toast("Introduce tu n√∫mero");return;}
  loginBtn.disabled=true;
  try{
    const allowed=await isEntryAllowed(n);
    if(!allowed) throw new Error("Tu n√∫mero no est√° en la lista oficial.");
    const uRef=ref(db,`rooms/Sala de Prueba/users/${n}`);
    const snap=await get(uRef);
    let data=snap.exists()?snap.val():null;
    if(!data||!data.pin){
      const newPin=String(Math.floor(1000+Math.random()*9000));
      await set(uRef,{pin:newPin,active:true,created:Date.now()});
      showGeneratedPin(newPin);
      loginBtn.disabled=false;return;
    }
    if(p!==String(data.pin)) throw new Error("PIN incorrecto");
    await update(uRef,{connected:true,updated:Date.now()});
    toast("Inicio de sesi√≥n correcto");
  }catch(e){toast(e.message||"Error");}
  finally{loginBtn.disabled=false;}
}

loginBtn.onclick=doLogin;
pinInput.onkeydown=e=>{if(e.key==="Enter")doLogin();};
numInput.onkeydown=e=>{if(e.key==="Enter")doLogin();};
</script>
</body>
</html>
