<!DOCTYPE html>
<html lang="es">
<head>
<meta charset="utf-8"/>
<meta name="viewport" content="width=device-width, initial-scale=1"/>
<title>X Code Chat — Official (DEV)</title>

<link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;600;700&display=swap" rel="stylesheet">
<style>
  :root{
    --bg:#000; --fg:#fff; --muted:#cfcfcf; --line:#2a2a2a;
    --gold:#D0A500; --accent:#00ffbb; --danger:#ff5a5a;
  }
  *{box-sizing:border-box}
  html,body{height:100%}
  body{
    margin:0; background:var(--bg); color:var(--fg);
    font-family:Inter,system-ui,Roboto,Arial,sans-serif;
    display:flex; flex-direction:column; overflow:hidden;
  }

  .header{
    flex-shrink:0; padding:12px 14px; background:#111;
    border-bottom:1px solid var(--line); display:flex; align-items:center; justify-content:space-between;
  }
  .brand{display:flex; gap:10px; align-items:center}
  .ttl{font-weight:700;font-size:18px}
  .sub{font-size:12px;color:#9aa}
  .dot{width:10px;height:10px;border-radius:50%;display:inline-block;border:1px solid #555;margin-left:6px}
  .dot.green{background:#00d38f;border-color:#00d38f}
  .btn{appearance:none;border:1px solid #fff;background:#fff;color:#000;border-radius:10px;padding:8px 12px;font-weight:600;cursor:pointer}
  .btn.ghost{background:transparent;color:#fff;border-color:#555}
  .btn.sm{padding:6px 8px;font-size:13px}
  .main{display:flex; flex-direction:column; flex:1 1 auto; min-height:0}

  .card{background:#0b0b0b;border:1px solid var(--line);border-radius:16px;padding:14px}
  #loginCard{max-width:700px;margin:12px auto 0;display:flex;flex-direction:column;gap:10px}
  .field{display:flex;gap:8px;align-items:center;border:1px solid var(--line);border-radius:12px;padding:10px;background:#0a0a0a}
  .field input{flex:1;background:transparent;border:none;outline:none;color:var(--fg);font-size:16px}

  #adminCard{display:none;gap:12px;flex-direction:column;margin:12px;}
  .row{display:flex;gap:8px;flex-wrap:wrap;align-items:center}
  .tag{display:inline-block;border:1px solid #3a3a3a;border-radius:999px;padding:2px 8px;font-size:12px}
  .list{border:1px dashed var(--line);border-radius:12px;padding:10px;max-height:220px;overflow:auto}
  .smallInput{min-width:200px;background:#111;color:#fff;border:1px solid #333;padding:8px 10px;border-radius:8px}

  #chatCard{display:none; flex:1 1 auto; min-height:0; padding:12px}
  .chatShell{display:flex; flex-direction:column; height:100%; gap:10px}
  #messages{flex:1 1 auto; min-height:0; overflow:auto; padding:14px; display:flex; flex-direction:column; gap:10px; border:1px solid var(--line); border-radius:14px; background:#0f0f0f;}
  .msg{max-width:88%;padding:10px 12px;border:1px solid #3a3a3a;border-radius:14px;background:#101010;white-space:pre-wrap;word-break:break-word}
  .msg.me{margin-left:auto;background:#141414;border-color:#555}
  .msg .by{font-size:12px;color:#9bd;margin-bottom:4px}
  .msg .meta{margin-top:6px;font-size:11px;color:#9a9a9a}

  .composer{display:flex;gap:8px;align-items:center;border-top:1px solid var(--line);padding:10px;background:#080808;border-radius:14px;flex-shrink:0}
  .composer .field{flex:1}
  .composer input{color:#fff}

  @media (max-width:560px){ .ttl{font-size:16px} }
</style>
</head>
<body>

  <div class="header">
    <div class="brand">
      <div>
        <div class="ttl">X Code Chat — Official (DEV)</div>
        <div class="sub">Sala: <b id="roomHdr">Sala de Prueba 3</b></div>
        <div class="sub" id="userUnder">Usuario #?</div>
      </div>
    </div>
    <div class="row">
      <span class="sub">Estado</span><span id="statusDot" class="dot"></span>
      <button id="logoutBtn" class="btn ghost" style="display:none">Salir</button>
    </div>
  </div>

  <div class="main">
    <!-- LOGIN -->
    <div id="loginCard" class="card">
      <div class="sub">Acceso con <b>número</b> y <b>PIN</b>. Usuario <b>0</b> es organizador.</div>
      <div class="field"><input id="numInput" type="number" placeholder="Tu número"></div>
      <div class="field"><input id="pinInput" type="password" placeholder="Tu PIN"></div>
      <div class="row"><button id="loginBtn" class="btn">Entrar</button></div>
    </div>

    <!-- ADMIN PANEL -->
    <div id="adminCard" class="card">
      <div class="sub" style="font-weight:600">Panel del organizador</div>
      <div class="row">
        <input id="roomInput" class="smallInput" placeholder="Nombre de sala"/>
        <button id="roomUseBtn" class="btn sm">Cambiar sala</button>
      </div>
      <div id="roomsGrid" class="list"></div>
    </div>

    <!-- CHAT -->
    <div id="chatCard" class="card">
      <div class="chatShell">
        <div id="messages"></div>
        <div class="composer">
          <div class="field"><input id="msgInput" type="text" placeholder="Mensaje…"/></div>
          <button id="sendBtn" class="btn">Enviar</button>
        </div>
      </div>
    </div>
  </div>

<script type="module">
import { initializeApp } from "https://www.gstatic.com/firebasejs/10.13.1/firebase-app.js";
import { getDatabase, ref, get, set, update, onValue } from "https://www.gstatic.com/firebasejs/10.13.1/firebase-database.js";

const firebaseConfig = {
  apiKey: "TU_API_KEY_DEV",
  authDomain: "TU_AUTH_DOMAIN_DEV",
  databaseURL: "https://TU_PROYECTO_DEV.firebaseio.com",
  projectId: "TU_PROJECT_ID_DEV",
  storageBucket: "TU_STORAGE_BUCKET_DEV",
  messagingSenderId: "TU_SENDER_ID_DEV",
  appId: "TU_APP_ID_DEV"
};
const app = initializeApp(firebaseConfig);
const db  = getDatabase(app);

const $ = q => document.querySelector(q);
const loginBtn=$("#loginBtn"), numInput=$("#numInput"), pinInput=$("#pinInput");
const loginCard=$("#loginCard"), chatCard=$("#chatCard"), adminCard=$("#adminCard");
const logoutBtn=$("#logoutBtn"), msgInput=$("#msgInput"), sendBtn=$("#sendBtn");
const roomHdr=$("#roomHdr"), userUnder=$("#userUnder"), messages=$("#messages"), roomInput=$("#roomInput"), roomUseBtn=$("#roomUseBtn");

let session={room:localStorage.getItem("xcode:lastRoom")||"Sala de Prueba 3",num:null,isAdmin:false};
roomHdr.textContent=session.room;

function saveRoom(r){
  session.room=r; roomHdr.textContent=r;
  localStorage.setItem("xcode:lastRoom",r);
}

function enterChat(admin){
  loginCard.style.display="none";
  logoutBtn.style.display="inline-flex";
  if(admin){ adminCard.style.display="flex"; chatCard.style.display="none"; }
  else{ adminCard.style.display="none"; chatCard.style.display="block"; attachMessages(); }
  userUnder.textContent=`Usuario #${session.num}`;
}

async function doLogin(){
  const num=parseInt(numInput.value.trim());
  const pin=pinInput.value.trim();
  if(isNaN(num)) return alert("Introduce tu número");
  if(num===0){ session.num=0; session.isAdmin=true; enterChat(true); return; }
  const uRef=ref(db,`rooms/${session.room}/users/${num}`);
  const snap=await get(uRef);
  if(!snap.exists()) return alert("Tu entrada no está activa");
  const data=snap.val();
  if(!pin) return alert("Introduce tu PIN");
  if(String(data.pin)!==pin) return alert("PIN incorrecto");
  session.num=num;
  enterChat(false);
}

loginBtn.onclick=doLogin;
numInput.onkeydown=e=>{if(e.key==="Enter")doLogin()};
pinInput.onkeydown=e=>{if(e.key==="Enter")doLogin()};

logoutBtn.onclick=()=>{
  session={room:localStorage.getItem("xcode:lastRoom")||"Sala de Prueba 3",num:null,isAdmin:false};
  adminCard.style.display="none"; chatCard.style.display="none";
  loginCard.style.display="flex"; logoutBtn.style.display="none";
  numInput.value=""; pinInput.value=""; userUnder.textContent="Usuario #?";
}

roomUseBtn.onclick=()=>{
  const newRoom=roomInput.value.trim();
  if(!newRoom) return alert("Introduce el nombre de la sala");
  saveRoom(newRoom);
  alert("Sala actualizada a: "+newRoom);
}

async function sendMessage(){
  const text=msgInput.value.trim(); if(!text)return;
  const id=Date.now();
  const payload={from:session.num,text,ts:Date.now()};
  await set(ref(db,`rooms/${session.room}/messages/${id}`),payload);
  msgInput.value="";
}

sendBtn.onclick=sendMessage;
msgInput.onkeydown=e=>{if(e.key==="Enter"){e.preventDefault();sendMessage();}};

function attachMessages(){
  const refMsgs=ref(db,`rooms/${session.room}/messages`);
  onValue(refMsgs,snap=>{
    messages.innerHTML="";
    const data=snap.val()||{};
    Object.values(data).sort((a,b)=>a.ts-b.ts).forEach(m=>{
      const div=document.createElement("div");
      div.className="msg"+(m.from===session.num?" me":"");
      div.innerHTML=`<div class='by'>Usuario #${m.from}</div><div>${m.text}</div><div class='meta'>${new Date(m.ts).toLocaleTimeString('es-ES',{hour:'2-digit',minute:'2-digit'})}</div>`;
      messages.appendChild(div);
    });
    messages.scrollTop=messages.scrollHeight;
  });
}
</script>
</body>
</html>
