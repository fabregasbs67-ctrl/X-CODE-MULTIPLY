<!DOCTYPE html>
<html lang="es">
<head>
<meta charset="utf-8"/>
<meta name="viewport" content="width=device-width, initial-scale=1"/>
<title>X Code Chat ‚Äî Official (DEV)</title>
<link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;600;700&display=swap" rel="stylesheet">
<style>
:root{ --bg:#000; --fg:#fff; --muted:#cfcfcf; --line:#2a2a2a; --gold:#D0A500; --accent:#00ffbb; --danger:#ff5a5a; }
*{box-sizing:border-box}
html,body{height:100%}
body{margin:0;background:var(--bg);color:var(--fg);font-family:Inter,system-ui,Roboto,Arial,sans-serif}
.wrap{max-width:980px;margin:0 auto;padding:12px;display:flex;flex-direction:column;gap:12px;min-height:100svh}
.card{background:#0b0b0b;border:1px solid var(--line);border-radius:16px;padding:14px}
.header{display:flex;align-items:center;justify-content:space-between;gap:10px}
.brand{display:flex;align-items:center;gap:10px}
.logo{width:28px;height:28px;border-radius:50%;display:grid;place-items:center;background:#111;border:1px solid var(--line);overflow:hidden}
.ttl{font-weight:700;font-size:20px}
.sub{font-size:13px;color:var(--muted)}
.btn{appearance:none;border:1px solid #fff;background:#fff;color:#000;border-radius:12px;padding:10px 14px;font-weight:600;cursor:pointer}
.btn.ghost{background:transparent;color:#fff}
.btn.danger{border-color:var(--danger);color:var(--danger);background:transparent}
.btn.sm{padding:8px 10px;font-size:13px;border-radius:10px}
.field{display:flex;align-items:center;gap:8px;border:1px solid var(--line);border-radius:12px;padding:10px;background:#0a0a0a}
.field input,.field select{flex:1;background:transparent;border:none;outline:none;color:var(--fg);font-size:16px}
.eye{cursor:pointer;user-select:none}
.login{max-width:700px;margin:6svh auto 0;display:flex;flex-direction:column;gap:10px}
.hint{color:var(--muted);font-size:13px}

/* Panel + Chat */
.chatGrid{display:flex;gap:12px;align-items:flex-start}
.adminPane{display:none;flex:0 0 320px;gap:12px;flex-direction:column}
.adminTabs{display:flex;gap:6px}
.tab{padding:6px 10px;border:1px solid var(--line);border-radius:10px;background:#0f0f0f;cursor:pointer}
.tab.active{outline:1px solid var(--gold)}
.tabPanel{display:none;gap:10px;flex-direction:column}
.tabPanel.show{display:flex}
.list{border:1px dashed var(--line);border-radius:12px;padding:10px;max-height:260px;overflow:auto}
.row{display:flex;gap:8px;align-items:center;flex-wrap:wrap}
.tag{display:inline-block;border:1px solid #3a3a3a;border-radius:999px;padding:2px 8px;font-size:12px}
.ok{color:#00d38f;border-color:#00d38f}
.bad{color:#ff6a6a;border-color:#ff6a6a}
.dot{width:10px;height:10px;border-radius:50%;display:inline-block;border:1px solid #555;margin-left:6px}
.dot.green{background:#00d38f;border-color:#00d38f}
.dot.orange{background:#ffb020;border-color:#ffb020}
.dot.red{background:#ff5a5a}

/* Chat con scroll interno */
.chatCard{flex:1 1 auto;display:flex;flex-direction:column;gap:10px}
.messages{flex:1 1 auto;min-height:320px;max-height:60svh;overflow:auto;padding:14px;display:flex;flex-direction:column;gap:10px;border:1px solid var(--line);border-radius:14px;background:#0f0f0f}
.msg{max-width:92%;padding:10px 12px;border:1px solid #3a3a3a;border-radius:14px;background:#101010;white-space:pre-wrap;word-break:break-word}
.msg.me{margin-left:auto;background:#141414;border-color:#555}
.msg .by{font-size:12px;color:#9bd;opacity:.85;margin-bottom:4px}
.msg .meta{margin-top:6px;font-size:11px;color:#9a9a9a}
.msg.sys{opacity:.85;border-style:dashed}
.composer{display:flex;gap:8px;align-items:center;border-top:1px solid var(--line);padding:10px;background:#080808;border-radius:14px;position:sticky;bottom:0}
.composer .field{flex:1}

/* Toast + Modal */
.toast{position:fixed;left:50%;transform:translateX(-50%);bottom:16px;background:#111;border:1px solid var(--line);color:#fff;padding:10px 14px;border-radius:12px;display:none;z-index:80}
.toast.show{display:block}
.backdrop{position:fixed;inset:0;background:rgba(0,0,0,.7);display:none;align-items:center;justify-content:center;z-index:1000;padding:16px}
.backdrop.show{display:flex!important}
.modal{background:#101010;border:1px solid var(--line);padding:20px 22px;border-radius:14px;width:min(420px,92vw);text-align:center;box-shadow:0 10px 28px rgba(0,0,0,.35)}
.modal h3{margin:0 0 8px 0;color:var(--gold)}
.modal p{margin:0 0 12px 0;color:#ddd}
.modal .actions{display:flex;gap:8px;justify-content:center}
kbd{font-family:monospace;border:1px solid #333;border-radius:6px;padding:1px 6px;background:#0a0a0a}

@media (max-width:820px){ .chatGrid{flex-direction:column} .adminPane{width:100%} }
@media (max-width:560px){ .messages{max-height:56svh} }
</style>
</head>
<body>
<div class="wrap">
  <!-- Header -->
  <div class="card header">
    <div class="brand">
      <span class="logo" aria-hidden="true">
        <svg viewBox="0 0 24 24" width="20" height="20" aria-hidden="true">
          <circle cx="12" cy="12" r="10" fill="none" stroke="#D0A500" stroke-width="2"></circle>
          <path d="M8 8 L16 16 M16 8 L8 16" stroke="#D0A500" stroke-width="2" stroke-linecap="round"></path>
        </svg>
      </span>
      <div>
        <div class="ttl">X Code Chat ‚Äî Official (DEV)</div>
        <div class="sub">Sala: <b id="roomHdr">Sala de Prueba</b></div>
      </div>
    </div>
    <div class="row">
      <span class="sub">Estado</span><span id="statusDot" class="dot" title="Estado Firebase"></span>
      <button id="logoutBtn" class="btn ghost" style="display:none">Salir</button>
    </div>
  </div>

  <!-- Login -->
  <div id="loginCard" class="card login">
    <div class="hint">Acceso con <b>n√∫mero</b> y <b>PIN</b>. Si tu entrada est√° en la lista oficial, la primera vez se genera tu PIN y se muestra. Usuario <b>0</b> es organizador.</div>
    <div class="field"><input id="numInput" type="number" inputmode="numeric" placeholder="Tu n√∫mero (ej. 70)"></div>
    <div class="field"><input id="pinInput" type="password" inputmode="numeric" placeholder="Tu PIN"><span id="togglePin" class="eye">üëÅÔ∏è</span></div>
    <div class="row"><button id="loginBtn" class="btn">Entrar</button><div id="loginMsg" class="hint"></div></div>
    <div class="hint">Privado: escribe <kbd>@n√∫mero</kbd> al inicio (ej. <kbd>@120 hola</kbd>).</div>
  </div>

  <!-- Panel principal (Admin + Chat) -->
  <div class="chatGrid" id="mainGrid" style="display:none">
    <!-- Admin -->
    <aside id="adminPane" class="card adminPane">
      <div class="sub" style="font-weight:600">Panel del organizador</div>
      <div class="adminTabs">
        <div id="tabRooms" class="tab active">Salas</div>
        <div id="tabUsers" class="tab">Usuarios</div>
      </div>

      <!-- TAB: SALAS -->
      <div id="panelRooms" class="tabPanel show">
        <div class="row">
          <div class="field" style="flex:1"><input id="roomInput" placeholder="Sala actual‚Ä¶"/></div>
          <button id="roomUseBtn" class="btn sm">Usar</button>
          <button id="btnReloadRooms" class="btn sm ghost">Recargar</button>
        </div>
        <div class="row">
          <div class="field" style="flex:1"><input id="newRoomName" placeholder="Nueva sala‚Ä¶"/></div>
          <button id="btnCreateRoom" class="btn sm">Crear sala</button>
        </div>
        <div id="roomsList" class="list"></div>
      </div>

      <!-- TAB: USUARIOS -->
      <div id="panelUsers" class="tabPanel">
        <div class="row">
          <div class="field" style="flex:1;max-width:220px"><input id="userNumber" type="number" placeholder="N√∫mero (ej. 8)"/></div>
          <button id="btnActivateUser" class="btn sm">Activar</button>
          <button id="btnDeactivateUser" class="btn sm danger">Desactivar</button>
          <button id="btnDeleteUser" class="btn sm danger">Eliminar</button>
        </div>
        <div class="sub">Conectados: <b id="countConn">0</b></div>
        <div id="usersList" class="list"></div>
      </div>
    </aside>

    <!-- Chat -->
    <section id="chatCard" class="card chatCard">
      <div id="messages" class="messages"></div>
      <div class="composer">
        <div class="field"><input id="msgInput" type="text" placeholder="Mensaje‚Ä¶  ¬∑  Privado con @n√∫mero" autocomplete="off" maxlength="400"></div>
        <button id="sendBtn" class="btn">Enviar</button>
      </div>
      <div class="hint">Remitente visible: <b>Usuario #<span id="meId">?</span></b></div>
    </section>
  </div>
</div>

<div id="toast" class="toast"></div>

<!-- Modal PIN (primera vez) -->
<div id="pinBack" class="backdrop" aria-hidden="true">
  <div class="modal" role="dialog" aria-modal="true">
    <h3>üîê Tu PIN</h3>
    <p id="pinText" style="font-size:1.6em;font-weight:800;color:var(--accent)">0000</p>
    <small style="opacity:.8">Se ha copiado al portapapeles</small>
    <div class="actions" style="margin-top:12px"><button id="pinOk" class="btn">Entendido</button></div>
  </div>
</div>

<script type="module">
/* --------------------------------------------------------------------
   Firebase (DEV)
-------------------------------------------------------------------- */
import { initializeApp } from "https://www.gstatic.com/firebasejs/10.13.1/firebase-app.js";
import { getDatabase, ref, get, set, update, onValue, off, remove } from "https://www.gstatic.com/firebasejs/10.13.1/firebase-database.js";

const firebaseConfig = {
  apiKey: "AIzaSyDtA7FlHCN6GaibDINRF6AF2uuLoPbgpK4",
  authDomain: "x-code-chat-dev.firebaseapp.com",
  databaseURL: "https://x-code-chat-dev-default-rtdb.europe-west1.firebasedatabase.app",
  projectId: "x-code-chat-dev",
  storageBucket: "x-code-chat-dev.firebasestorage.app",
  messagingSenderId: "464335717187",
  appId: "1:464335717187:web:e39794c19e000c34dca5f6"
};

const app = initializeApp(firebaseConfig);
const db  = getDatabase(app);

/* --------------------------------------------------------------------
   Utilidades / Estado
-------------------------------------------------------------------- */
const $ = s=>document.querySelector(s);
const roomHdr=$("#roomHdr");
const loginCard=$("#loginCard"), mainGrid=$("#mainGrid");
const logoutBtn=$("#logoutBtn");
const numInput=$("#numInput"), pinInput=$("#pinInput"), loginBtn=$("#loginBtn"), togglePin=$("#togglePin");
const messages=$("#messages"), msgInput=$("#msgInput"), sendBtn=$("#sendBtn");
const meIdSpan=$("#meId");
const toastEl=$("#toast");
const pinBack=$("#pinBack"), pinText=$("#pinText"), pinOk=$("#pinOk");
const adminPane=$("#adminPane"), statusDot=$("#statusDot");

/* Admin UI */
const tabRooms=$("#tabRooms"), tabUsers=$("#tabUsers");
const panelRooms=$("#panelRooms"), panelUsers=$("#panelUsers");

/* Salas UI */
const roomInput=$("#roomInput"), roomUseBtn=$("#roomUseBtn");
const btnReloadRooms=$("#btnReloadRooms"), newRoomName=$("#newRoomName");
const btnCreateRoom=$("#btnCreateRoom"), roomsList=$("#roomsList");

/* Users UI */
const userNumber=$("#userNumber");
const btnActivateUser=$("#btnActivateUser");
const btnDeactivateUser=$("#btnDeactivateUser");
const btnDeleteUser=$("#btnDeleteUser");
const usersList=$("#usersList"), countConn=$("#countConn");

/* Config com√∫n */
const ENTRY_WHITELIST_PATHS = ["entradas","tickets"];
const DEFAULT_ROOM = "Sala de Prueba";
const ADMIN_PASS = "131215";

/* Persistencias locales */
const LS_LAST_ROOM = "xcode:lastRoom";     // √∫ltima sala elegida por organizador
const LS_SESSION   = "xcode:session";      // sesi√≥n persistente (num,pin,room,isAdmin)

/* Sesi√≥n en memoria */
let session = { room: DEFAULT_ROOM, num:null, isAdmin:false };
roomHdr.textContent=session.room;
roomInput.value=session.room;

/* Unsub handlers y timers */
let detachMsgs=null, detachUsers=null, usersCache={}, usersTimer=null, statusTimer=null;

/* --------------------------------------------------------------------
   Helpers
-------------------------------------------------------------------- */
const toast = (t,ms=2400)=>{ toastEl.textContent=t; toastEl.classList.add("show"); clearTimeout(window.__t); window.__t=setTimeout(()=>toastEl.classList.remove("show"),ms); };
togglePin.onclick = ()=> pinInput.type = (pinInput.type==="password" ? "text" : "password");
const hhmm = ts=> new Date(ts||Date.now()).toLocaleTimeString('es-ES',{hour:'2-digit',minute:'2-digit'});
const newPIN = ()=> String(Math.floor(1000+Math.random()*9000));
const roomRef = (room, path) => ref(db, `rooms/${room}/${path}`);
const currentRoomRef = path => roomRef(session.room, path);

/* Persistencia sala organizador */
const saveLastRoom = r => { try{ localStorage.setItem(LS_LAST_ROOM, r); }catch{} }
const loadLastRoom = () => { try{ return localStorage.getItem(LS_LAST_ROOM) || DEFAULT_ROOM; }catch{ return DEFAULT_ROOM } }

/* Persistencia sesi√≥n */
function saveSession(){
  try{
    const payload = { num:session.num, pin:pinInput.value||"", room:session.room, isAdmin:!!session.isAdmin };
    localStorage.setItem(LS_SESSION, JSON.stringify(payload));
  }catch{}
}
function clearSession(){
  try{ localStorage.removeItem(LS_SESSION); }catch{}
}
function loadSession(){
  try{
    const raw = localStorage.getItem(LS_SESSION);
    if(!raw) return null;
    return JSON.parse(raw);
  }catch{ return null; }
}

/* --------------------------------------------------------------------
   Lista blanca de entradas
-------------------------------------------------------------------- */
async function isEntryAllowed(n){
  for(const base of ENTRY_WHITELIST_PATHS){
    const s=await get(ref(db, `${base}/${n}`));
    if(s.exists()){
      const d=s.val()||{};
      const estado = d.estado? String(d.estado).toLowerCase() : null;
      if(estado==="activa"||estado==="activo"||d.active===true||d.active==="true") return true;
    }
  }
  return false;
}

/* --------------------------------------------------------------------
   Normaliza users/{n}/{n} -> users/{n}
-------------------------------------------------------------------- */
async function normalizeUserNode(room,n){
  const base = `rooms/${room}/users/${n}`;
  const uRef = ref(db, base);
  const nestedRef = ref(db, `${base}/${n}`);
  const uSnap = await get(uRef);
  const nestedSnap = await get(nestedRef);
  if(nestedSnap.exists()){
    const nested = nestedSnap.val();
    const already = uSnap.exists()? uSnap.val() : null;
    if(!already || !already.pin){
      await set(uRef, nested);
      await set(nestedRef, null);
      return (await get(uRef)).val();
    }
  }
  return uSnap.exists()? uSnap.val() : null;
}

/* --------------------------------------------------------------------
   LOGIN
-------------------------------------------------------------------- */
async function doLogin(){
  const nStr=(numInput.value||"").trim();
  if(!/^\d+$/.test(nStr)){ toast("Introduce tu n√∫mero"); return; }
  const n=Number(nStr);
  const pTyped=(pinInput.value||"").trim();

  loginBtn.disabled=true;
  try{
    /* Organizador */
    if(n===0){
      const pass=prompt("Contrase√±a de organizador:");
      if(pass!==ADMIN_PASS) throw new Error("Contrase√±a incorrecta.");
      session.num=0; session.isAdmin=true;

      /* Cargar √∫ltima sala usada por organizador */
      const last = loadLastRoom();
      session.room = last || DEFAULT_ROOM;
      roomHdr.textContent=session.room; roomInput.value=session.room;

      enterChat(true);
      saveSession(); // guarda sesi√≥n admin sin volver a pedir pass al refrescar
      return;
    }

    const allowed = await isEntryAllowed(n);
    if(!allowed) throw new Error("Tu n√∫mero no est√° en la lista oficial.");

    let data = await normalizeUserNode(session.room, n);
    if(!data || !data.pin){
      const pin=newPIN();
      await set(roomRef(session.room,`users/${n}`), { pin, active:true, connected:false, created:Date.now(), updated:Date.now() });
      showGeneratedPin(pin);
      loginBtn.disabled=false; return;
    }

    if(!pTyped){ throw new Error("Introduce tu PIN"); }
    if(String(data.pin)!==String(pTyped)) throw new Error("PIN incorrecto");

    await update(roomRef(session.room,`users/${n}`), { connected:true, updated:Date.now() });
    session.num=n; session.isAdmin=false;
    enterChat(false);
    saveSession(); // guarda num/pin/room para restaurar sesi√≥n
  }catch(err){ toast(err.message||"No se pudo iniciar sesi√≥n"); }
  finally{ loginBtn.disabled=false; }
}
loginBtn.onclick = doLogin;
numInput.onkeydown = e=>{ if(e.key==="Enter") doLogin(); };
pinInput.onkeydown = e=>{ if(e.key==="Enter") doLogin(); };

function showGeneratedPin(pin){
  pinText.textContent = pin;
  pinBack.classList.add("show");
  pinBack.style.display="flex";
  pinBack.setAttribute("aria-hidden","false");
  navigator.clipboard.writeText(pin).catch(()=>{});
  pinOk.onclick = ()=>{
    pinBack.classList.remove("show");
    pinBack.style.display="none";
    pinBack.setAttribute("aria-hidden","true");
    toast("Introduce tu PIN y pulsa Entrar");
  };
}

/* --------------------------------------------------------------------
   ENTRAR / SALIR
-------------------------------------------------------------------- */
function enterChat(isAdmin){
  loginCard.style.display="none";
  mainGrid.style.display="flex";
  logoutBtn.style.display="inline-flex";
  meIdSpan.textContent=session.num;

  if(isAdmin || session.num===0){
    adminPane.style.display="flex";
    reloadRooms();
    loadUsersRealtime();
    if(!usersTimer) usersTimer=setInterval(updateUsersAgo, 30000);
    if(!statusTimer) statusTimer=setInterval(pingStatusOnce, 10000);
    setTimeout(pingStatusOnce,600);
  }else{
    adminPane.style.display="none";
  }

  attachMessages();
  setTimeout(()=> msgInput?.focus(), 50);
}

async function doLogout(){
  try{ if(session.num>0){ await update(currentRoomRef(`users/${session.num}`), { connected:false, updated:Date.now() }); } }catch{}
  if(detachMsgs){ detachMsgs(); detachMsgs=null; }
  if(detachUsers){ detachUsers(); detachUsers=null; }
  if(usersTimer){ clearInterval(usersTimer); usersTimer=null; }
  if(statusTimer){ clearInterval(statusTimer); statusTimer=null; }
  clearSession();
  mainGrid.style.display="none"; logoutBtn.style.display="none";
  adminPane.style.display="none";
  loginCard.style.display="flex";
  messages.innerHTML=""; msgInput.value="";
  session={ room: DEFAULT_ROOM, num:null, isAdmin:false };
  roomHdr.textContent=session.room; roomInput.value=session.room;
}
logoutBtn.onclick = doLogout;

/* --------------------------------------------------------------------
   MENSAJES
-------------------------------------------------------------------- */
function renderMsg(m){
  if(m.sys && session.num!==0) return;
  if(m.to && !(m.to===session.num || m.from===session.num || session.num===0)) return;

  const div=document.createElement("div");
  div.className="msg"+(m.from===session.num?" me":"")+(m.sys?" sys":"");
  const by=document.createElement("div");
  by.className="by";
  by.textContent = (m.from===0? "Organizador" : `Usuario #${m.from}`) + (m.to? ` ‚Üí #${m.to}` : "");
  const text=document.createElement("div");
  text.textContent = m.text || "";
  const meta=document.createElement("div");
  meta.className="meta";
  meta.textContent = hhmm(m.ts) || "";
  div.appendChild(by); div.appendChild(text); div.appendChild(meta);
  messages.appendChild(div);
}

function attachMessages(){
  if(detachMsgs){ detachMsgs(); detachMsgs=null; }
  const r = currentRoomRef("messages");
  const handler = (snap)=>{
    messages.innerHTML="";
    const val=snap.val()||{};
    const arr=Object.values(val).sort((a,b)=>(a.ts||0)-(b.ts||0));
    arr.forEach(renderMsg);
    messages.scrollTop = messages.scrollHeight;
  };
  onValue(r, handler);
  detachMsgs = ()=> off(r, "value", handler);
}

async function sendMessage(){
  const raw=(msgInput.value||"").trim(); if(!raw) return;
  const id=Date.now()+"_"+Math.random().toString(36).slice(2,8);
  let payload={ from: session.num, text: raw, ts: Date.now() };
  const m = raw.match(/^@(\d+)\s+(.+)/);
  if(m){ payload.to = Number(m[1]); payload.text = m[2]; }
  await set(currentRoomRef(`messages/${id}`), payload);
  msgInput.value="";
  messages.scrollTop = messages.scrollHeight;
}
sendBtn.onclick = sendMessage;
msgInput.onkeydown = (e)=>{ if(e.key==="Enter"){ e.preventDefault(); sendMessage(); }};

/* --------------------------------------------------------------------
   ESTADO FIREBASE (ping) ‚Äî nombre √∫nico
-------------------------------------------------------------------- */
async function pingStatusOnce(){
  if(session.num!==0) return;
  const pingId = "PING_"+Date.now()+"_"+Math.random().toString(36).slice(2,5);
  const msg = { from:0, text:`[PING ${pingId}]`, ts:Date.now(), sys:true };
  const start = performance.now();
  let done=false;

  const r=currentRoomRef("messages");
  const handler=(snap)=>{
    if(done) return;
    const val=snap.val()||{};
    const found = Object.values(val).some(m=> m && m.sys && typeof m.text==="string" && m.text.includes(pingId));
    if(found){
      done=true; off(r,"value",handler);
      const ms = performance.now()-start;
      statusDot.className = "dot " + (ms<2000? "green" : "orange");
      setTimeout(()=> remove(currentRoomRef(`messages/${pingId}`)).catch(()=>{}), 2500);
    }
  };
  onValue(r, handler);
  await set(currentRoomRef(`messages/${pingId}`), msg);
  setTimeout(()=>{
    if(!done){
      off(r,"value",handler);
      statusDot.className = "dot red";
      remove(currentRoomRef(`messages/${pingId}`)).catch(()=>{});
    }
  }, 3000);
}

/* --------------------------------------------------------------------
   ADMIN ‚Äî TABS
-------------------------------------------------------------------- */
function setActiveTab(tab){
  tabRooms.classList.remove("active");
  tabUsers.classList.remove("active");
  panelRooms.classList.remove("show");
  panelUsers.classList.remove("show");
  if(tab==="rooms"){ tabRooms.classList.add("active"); panelRooms.classList.add("show"); }
  else{ tabUsers.classList.add("active"); panelUsers.classList.add("show"); }
}
tabRooms.onclick=()=>setActiveTab("rooms");
tabUsers.onclick=()=>setActiveTab("users");

/* --------------------------------------------------------------------
   ADMIN ‚Äî Salas
-------------------------------------------------------------------- */
function roomMetaRef(name){ return ref(db, `roomsMeta/${name}`); }
function roomIndexRef(name){ return ref(db, `rooms_index/${name}`); }

async function reloadRooms(){
  roomsList.innerHTML = "<div class='sub'>Cargando salas‚Ä¶</div>";
  const snap = await get(ref(db, "roomsMeta"));
  roomsList.innerHTML = "";
  const data = snap.val()||{};
  const names = Object.keys(data).sort((a,b)=> a.localeCompare(b));
  if(!names.length){
    roomsList.innerHTML = "<div class='sub'>No hay salas todav√≠a.</div>";
    return;
  }
  names.forEach(name=>{
    const box=document.createElement("div");
    box.className="row";
    const cur = (name===session.room) ? " ¬∑ <span class='tag ok'>en uso</span>" : "";
    box.innerHTML = `<b>${name}</b>${cur}
      <button class="btn sm" data-act="use">Usar</button>
      <button class="btn sm ghost" data-act="rename">Renombrar</button>
      <button class="btn sm danger" data-act="delete">Eliminar</button>`;
    box.querySelector('[data-act=use]').onclick=()=>{ roomInput.value=name; roomUseBtn.click(); };
    box.querySelector('[data-act=rename]').onclick=async()=>{
      const newName = prompt("Nuevo nombre para la sala:", name);
      if(!newName || newName===name) return;
      const exists = await get(roomMetaRef(newName));
      if(exists.exists()){ toast("Ya existe una sala con ese nombre"); return; }
      if(!confirm(`Renombrar "${name}" a "${newName}"?`)) return;
      await set(roomMetaRef(newName), { name:newName, updatedAt:Date.now() });
      await set(roomIndexRef(newName), true);
      await remove(roomMetaRef(name)); await remove(roomIndexRef(name));
      if(session.room===name){ session.room=newName; roomHdr.textContent=newName; roomInput.value=newName; saveLastRoom(newName); attachMessages(); loadUsersRealtime(); }
      toast("Sala renombrada"); reloadRooms();
    };
    box.querySelector('[data-act=delete]').onclick=async()=>{
      if(!confirm(`¬øEliminar la sala "${name}" y TODOS sus usuarios/mensajes?`)) return;
      if(!confirm("Esta acci√≥n no se puede deshacer. Confirmar borrado.")) return;
      await remove(ref(db, `rooms/${name}`)).catch(()=>{});
      await remove(roomMetaRef(name)).catch(()=>{});
      await remove(roomIndexRef(name)).catch(()=>{});
      if(session.room===name){
        session.room=DEFAULT_ROOM;
        roomHdr.textContent=session.room; roomInput.value=session.room;
        saveLastRoom(session.room);
        attachMessages(); loadUsersRealtime();
      }
      toast("Sala eliminada"); reloadRooms();
    };
    roomsList.appendChild(box);
  });
}

roomUseBtn.onclick=()=>{
  const newRoom=(roomInput.value||"").trim();
  if(!newRoom) return toast("Escribe un nombre de sala");
  if(newRoom===session.room) return;
  session.room=newRoom;
  roomHdr.textContent=newRoom;
  saveLastRoom(newRoom); /* persistir elecci√≥n del organizador */
  attachMessages();
  if(session.num===0) { loadUsersRealtime(); }
  saveSession(); /* actualizar la sala guardada en la sesi√≥n */
  toast(`Sala cambiada a "${newRoom}"`);
};

btnCreateRoom.onclick = async ()=>{
  const name=(newRoomName.value||"").trim();
  if(!name) return toast("Escribe un nombre para la sala");

  const exists = await get(roomMetaRef(name));
  if(exists.exists()){ toast("Esa sala ya existe"); return; }

  await set(roomMetaRef(name), { name, createdAt:Date.now(), updatedAt:Date.now() });
  await set(roomIndexRef(name), true);
  toast("Sala creada");
  newRoomName.value="";
  reloadRooms();
};
btnReloadRooms.onclick = reloadRooms;

/* --------------------------------------------------------------------
   ADMIN ‚Äî Usuarios
-------------------------------------------------------------------- */
function updateUsersAgo(){
  [...usersList.querySelectorAll("[data-uid]")].forEach(el=>{
    const uid=el.getAttribute("data-uid");
    const u=usersCache[uid];
    if(u){
      const ago=el.querySelector(".ago");
      const ts=u.updated || u.created || Date.now();
      if(ago) ago.textContent = "hace " + timeAgo(ts);
    }
  });
}
function timeAgo(ts){
  if(!ts) return "‚Äî";
  const s = Math.floor((Date.now()-ts)/1000);
  if(s<60) return `${s}s`;
  const m = Math.floor(s/60);
  if(m<60) return `${m}m`;
  const h = Math.floor(m/60); return `${h}h`;
}

function loadUsersRealtime(){
  if(detachUsers){ detachUsers(); detachUsers=null; }
  const r=currentRoomRef("users");
  const handler=(snap)=>{
    usersList.innerHTML="";
    const users=snap.val()||{};
    usersCache=users;
    let connected=0;
    Object.keys(users).sort((a,b)=>Number(a)-Number(b)).forEach(k=>{
      const u=users[k]||{};
      if(u.connected) connected++;
      const row=document.createElement("div");
      row.setAttribute("data-uid",k);
      row.className="row";
      const badge = `<span class="tag ${u.connected?"ok":"bad"}">${u.connected?"conectado":"desconectado"}</span>`;
      const agoTxt = `hace ${timeAgo(u.updated || u.created || Date.now())}`;
      row.innerHTML = `<b>#${k}</b> ¬∑ PIN <span class="tag">${u.pin||"‚Äî"}</span> ${badge} <span class="sub ago">${agoTxt}</span>
        <button class="btn sm" data-a="act">Activar</button>
        <button class="btn sm danger" data-a="deact">Desactivar</button>
        <button class="btn sm danger" data-a="del">Eliminar</button>`;
      row.querySelector('[data-a=act]').onclick=()=> setEntryState(k,true);
      row.querySelector('[data-a=deact]').onclick=()=> setEntryState(k,false);
      row.querySelector('[data-a=del]').onclick=()=> deleteUser(k);
      usersList.appendChild(row);
    });
    countConn.textContent=connected;
  };
  onValue(r, handler);
  detachUsers=()=>off(r,"value",handler);
}

async function setEntryState(n, active){
  if(!/^\d+$/.test(String(n))) { toast("N√∫mero inv√°lido"); return; }
  const estado = active ? "activa" : "inactiva";
  await set(ref(db, `entradas/${n}`), { estado });
  toast(active? "Usuario ACTIVADO" : "Usuario desactivado");
}
async function deleteUser(n){
  if(!confirm(`Eliminar usuario #${n} de la sala "${session.room}"?`)) return;
  await remove(currentRoomRef(`users/${n}`)).catch(()=>{});
  await set(ref(db, `entradas/${n}`), { estado: "inactiva" }).catch(()=>{});
  toast("Usuario eliminado");
}

btnActivateUser.onclick = async ()=>{
  const n = Number((userNumber.value||"").trim());
  if(!n && n!==0) return toast("N√∫mero inv√°lido");
  await setEntryState(n,true);
};
btnDeactivateUser.onclick = async ()=>{
  const n = Number((userNumber.value||"").trim());
  if(!n && n!==0) return toast("N√∫mero inv√°lido");
  await setEntryState(n,false);
};
btnDeleteUser.onclick = async ()=>{
  const n = Number((userNumber.value||"").trim());
  if(!n && n!==0) return toast("N√∫mero inv√°lido");
  await deleteUser(n);
};

/* --------------------------------------------------------------------
   Restauraci√≥n autom√°tica de sesi√≥n al cargar
-------------------------------------------------------------------- */
async function tryRestoreSession(){
  const saved = loadSession();
  if(!saved) return; // no hay sesi√≥n
  try{
    // Cargar sala persistida (si existe)
    session.room = saved.room || loadLastRoom() || DEFAULT_ROOM;
    roomHdr.textContent=session.room;
    roomInput.value=session.room;

    // ADMIN restaurado
    if(saved.isAdmin && String(saved.num)==="0"){
      session.num = 0; session.isAdmin = true;
      enterChat(true);
      return;
    }

    // Usuario normal: revalidar que sigue permitido y que el PIN coincide
    const allowed = await isEntryAllowed(saved.num);
    if(!allowed){ clearSession(); return; }

    const data = await normalizeUserNode(session.room, saved.num);
    if(!data || String(data.pin)!==String(saved.pin)){ clearSession(); return; }

    await update(roomRef(session.room,`users/${saved.num}`), { connected:true, updated:Date.now() });
    session.num = Number(saved.num); session.isAdmin = false;
    // Rellenar inputs por si el usuario abre el panel
    numInput.value = saved.num;
    pinInput.value = saved.pin;
    enterChat(false); // entra directo sin pedir PIN
  }catch{
    // si falla, limpiamos para no bloquear el login manual
    clearSession();
  }
}

/* --------------------------------------------------------------------
   INIT
-------------------------------------------------------------------- */
function sessionLoad(){
  // precargar √∫ltima sala en header/inputs
  const last = loadLastRoom();
  if(last){ session.room = last; roomHdr.textContent=last; roomInput.value=last; }
}
sessionLoad();
tryRestoreSession();
</script>
</body>
</html>
